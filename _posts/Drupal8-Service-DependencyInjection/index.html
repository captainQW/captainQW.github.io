<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="law">
        <link rel="canonical" href="https://www.verynil.com/_posts/Drupal8-Service-DependencyInjection/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>"Drupal8-Service-DependencyInjection" - 记录技术，分享知识，传播乐趣</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <a class="navbar-brand" href="../..">记录技术，分享知识，传播乐趣</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../index.md" class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../about.md" class="nav-link">About</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Documents <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../chapters/usage.md" class="dropdown-item">Usage</a>
</li>
                                    
<li>
    <a href="../../chapters/tutorial.md" class="dropdown-item">Tutorial</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/captainQW/captainQW.github.io/edit/master/docs/_posts/Drupal8-Service-DependencyInjection.md" class="nav-link">Edit on verynil.github.io</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            
            
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<hr />
<p>先来认识几个名词：</p>
<p>1、Service</p>
<p>Drupal8的service帮助代码去耦合，提高重复利用。比如操作数据库，发送mail等。一般来说，service是一个PHP类，包含了一些全局的方法。</p>
<p>2、Service Container</p>
<p>Service Container用来管理service。service的类会被注册在container中，来控制访问权限。在自定义模块中，可以用module_name.services.yml来实例化services，进而保存进container对象中。</p>
<p>3、Dependency Injection</p>
<p>如果要传递对象给另一个对象，一般用Dependency Injection来去耦。简单点说，一个service只处理一件事情，如果它要调用另外一个service，那么后面的这个service可以注入到前面的service中。</p>
<p>下文我们以service表示Service，container表示Service Container，DI表示Dependency Injection。</p>
<h3 id="core-services">一、core services</h3>
<p>Drupal8的核心servive都在<a href="https://api.drupal.org/api/drupal/core%21core.services.yml/8">core.services.yml</a>中。</p>
<p>当然，也可以在module_name.services.yml中自定义service。</p>
<p>*.services.yml的写法如：</p>
<pre><code class="language-php">  path.alias_manager:
    class: Drupal\Core\Path\AliasManager
    arguments: ['@path.crud', '@path.alias_whitelist', '@language_manager']
  breadcrumb:
    class: Drupal\Core\Breadcrumb\BreadcrumbManager
    arguments: ['@module_handler']
</code></pre>
<p>如要把别的service当作工厂使用，写法如下：</p>
<pre><code class="language-php">  cache.entity:
    class: Drupal\Core\Cache\CacheBackendInterface
    tags:
      - { name: cache.bin }
    factory: cache_factory:get
    arguments: [entity]
</code></pre>
<p>1、第一行定义了一个唯一的service名称，如果是自定义的模块，必须以模块名作为前缀。
2、第二行定义了默认调用的类、工厂类、接口类等。
3、arguments带@表示依赖于该service。
4、factory表示调用哪个工厂方法。
5、tags标签定义了一组关联的service，或指定具有某些相似特性的service。如果定义了service标签，在service类中必须实现相应的接口，如：
    &gt; access_check: 标明路由访问检查service
    &gt; cache.bin: 标明cache bin service
    &gt; event_subscriber: 标明一个事件订阅service。
    &gt; needs_destruction: 标明一个destructor()方法，通常被调用于一个请求完成时。
    &gt; context_provice: 标明一个block上下文提供者。
    &gt; http_client_middleware: 标明该service提供者是一个guzzle中间件。</p>
<h3 id="service">二、访问service</h3>
<h4 id="1global-functions">1、全局函数(global functions)</h4>
<p>Drupal8的全局类提供了一些静态方法去访问一些通用的service。如Drupal::moduleHandler()将返回模块处理service，Drupal.translation()将返回翻译service。用 Drupal::service()可以获取所有已经定义的service。</p>
<p>如：访问一个数据库service</p>
<pre><code class="language-php">&lt;?php
// Returns a Drupal\Core\Database\Connection object.
$connection = \Drupal::database();
$result = $connection-&gt;select('node', 'n')
  -&gt;fields('n', array('nid'))
  -&gt;execute();
?&gt;
</code></pre>
<p>如：通过\Drupal::service()访问一个date service</p>
<pre><code class="language-php">&lt;?php
// Returns a Drupal\Core\Datetime\Date object.
$date = \Drupal::service('date');
?&gt;
</code></pre>
<p>如：自定义的demo模块</p>
<h4 id="2demoservicesyml">2、创建demo.services.yml</h4>
<pre><code class="language-php">services:
    demo.demo_service:
        class: Drupal\demo\DemoService
</code></pre>
<h4 id="3srcdemoservicephp">3、在src目录下创建DemoService.php</h4>
<pre><code class="language-php">&lt;?php

/**
 * @file
 * Contains Drupal\demo\DemoService.
 */

namespace Drupal\demo;

class DemoService {

  protected $demo_value;

  public function __construct() {
    $this-&gt;demo_value = 'Upchuk';
  }

  public function getDemoValue() {
    return $this-&gt;demo_value;
  }

}
?&gt;
</code></pre>
<p>可以直接这样访问demo service</p>
<pre><code class="language-php">$service = \Drupal::service('demo.demo_service');
</code></pre>
<h4 id="4service">4、重写默认service</h4>
<p>Drupal8允许在自定义的模块中重写已存在的service。如自定义了一个名为demo的模块。</p>
<p>1)、在demo的src文件中创建一个名为DemoServiceProvider.php文件。</p>
<p>2)、DemoServiceProvider必须实现<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21DependencyInjection%21ServiceModifierInterface.php/interface/ServiceModifierInterface/8"> \Drupal\Core\DependencyInjection\ServiceModifierInterface</a>.</p>
<p>3)、这个类必须包含一个方法：alter()。这个方法是告诉Drupal用你的类来替代默认的类。如：</p>
<pre><code class="language-php">  public function alter(ContainerBuilder $container) {
    // Override the language_manager class with a new class.
    $definition = $container-&gt;getDefinition('language_manager');
    $definition-&gt;setClass('Drupal\my_module\MyLanguageManager');
  }
</code></pre>
<h3 id="diservice">三、通过DI访问service</h3>
<p>这块比较重要，单独来讲一下。还是以demo模块为例。</p>
<h4 id="1demoservicesyml">1、创建demo.services.yml</h4>
<pre><code class="language-php">services:
    demo.demo_service:
        class: Drupal\demo\DemoService
</code></pre>
<h4 id="2srcdemoservicephp">2、在src目录下创建DemoService.php</h4>
<pre><code class="language-php">&lt;?php

/**
 * @file
 * Contains Drupal\demo\DemoService.
 */

namespace Drupal\demo;

class DemoService {

  protected $demo_value;

  public function __construct() {
    $this-&gt;demo_value = 'Upchuk';
  }

  public function getDemoValue() {
    return $this-&gt;demo_value;
  }

}
?&gt;
</code></pre>
<h4 id="3demoroutingyml">3、创建demo.routing.yml</h4>
<pre><code class="language-php">demo.demo:
  path: '/demo'
  defaults:
    _controller: '\Drupal\demo\Controller\DemoController:demo'
  requirements:
    _permission: 'access content'
</code></pre>
<h4 id="4srccontrollerdemocontrollerphp">4、在src/Controller目录下创建DemoController.php</h4>
<pre><code class="language-php">&lt;?php

/**
 * @file
 * Contains \Drupal\demo\Controller\DemoController.
 */

namespace Drupal\demo\Controller;

use Drupal\Core\Controller\ControllerBase;
use Symfony\Component\DependencyInjection\ContainerInterface;

/**
 * DemoController.
 */
class DemoController extends ControllerBase {

  protected $demoService;

  /**
   * Class constructor.
   */
  public function __construct($demoService) {
    $this-&gt;demoService = $demoService;
  }

  /**
   * {@inheritdoc}
   */
  public static function create(ContainerInterface $container) {
    return new static(
      $container-&gt;get('demo.demo_service')
    );
  }

  /**
   * Generates an example page.
   */
  public function demo() {
    return array(
      '#markup' =&gt; t('Hello @value!', array('@value' =&gt; $this-&gt;demoService-&gt;getDemoValue())),
    );
  }
}
?&gt;
</code></pre>
<p>create()方法创建了一个控制器类的实例，参数为container中获取到的service。这样，DemoService实例就可以存储到$demoService中，我们就可以调用getDemoValue()这个方法了。</p>
<h4 id="5demohello-upchuk">5、访问/demo的时候屏幕上就会出现Hello Upchuk!</h4>
<p>参考文章：
1、https://docs.acquia.com/articles/drupal-8-dependency-injection
2、http://katbailey.github.io/2013/05/15/dependency-injection-in-drupal-8/
3、https://www.drupal.org/node/2133171
4、http://redcrackle.com/blog/drupal-8/dependency-injection
5、https://api.drupal.org/api/drupal/core!core.api.php/group/container/8
6、http://www.sitepoint.com/building-drupal-8-module-configuration-management-service-container/
7、https://api.drupal.org/api/drupal/core%21core.api.php/group/service_tag/8</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
