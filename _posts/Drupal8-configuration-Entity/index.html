<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="law">
        <link rel="canonical" href="https://www.verynil.com/_posts/Drupal8-configuration-Entity/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>"Drupal8 Configuration Entity" - 记录技术，分享知识，传播乐趣</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">记录技术，分享知识，传播乐趣</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../index.md" class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../about.md" class="nav-link">About</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Documents <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../chapters/usage.md" class="dropdown-item">Usage</a>
</li>
                                    
<li>
    <a href="../../chapters/tutorial.md" class="dropdown-item">Tutorial</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a href="https://github.com/captainQW/captainQW.github.io/edit/master/docs/_posts/Drupal8-configuration-Entity.md" class="nav-link">Edit on verynil.github.io</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            
            
            
            
            
            
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<hr />
<p>Drupal8的实体由2部分组成，配置实体(configuration entities)和内容实体(content entities)。如图：
<img alt="Entity" src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222113456_92999.png" /></p>
<p>本节源代码见 https://github.com/RamboLau/drupal8-demos/tree/master/config_entities_example</p>
<p>内容实体见：http://verynull.com/2015/12/22/drupal8-content-entity/</p>
<h3 id="configuration-entity-interface">一、配置实体接口(configuration entity interface)</h3>
<p>在src目录下touch DemoInterface.php，DemoInterface继承并实现<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Config%21Entity%21ConfigEntityInterface.php/interface/ConfigEntityInterface/8">ConfigEntityInterface</a>。</p>
<pre><code class="language-php">&lt;?php

/**
 * @file
 * Contains \Drupal\demo\DemoInterface.
 */

namespace Drupal\demo;

use Drupal\Core\Config\Entity\ConfigEntityInterface;

/**
 * Provides an interface defining a demo entity type.
 */
interface DemoInterface extends ConfigEntityInterface {
  // Add get/set methods for your configuration properties here.
}

?&gt;
</code></pre>
<h3 id="configuration-entity-class">二、配置实体类(configuration entity class)</h3>
<p>在src目录下创建Entity目录，并touch src/Entity/Demo.php，在这个文件中我们将实现DemoEntity。</p>
<pre><code class="language-php">&lt;?php

/**
 * @file
 * Contains \Drupal\demo\Entity\Demo.
 */

namespace Drupal\demo\Entity;

use Drupal\Core\Config\Entity\ConfigEntityBase;
use Drupal\demo\DemoInterface;

/**
 * Defines the Demo entity.
 *
 * @ConfigEntityType(
 *   id = &quot;demo&quot;,
 *   label = @Translation(&quot;Demo&quot;),
 *   fieldable = FALSE,
 *   handlers = {
 *     &quot;list_builder&quot; = &quot;Drupal\demo\DemoListBuilder&quot;,
 *     &quot;form&quot; = {
 *       &quot;add&quot; = &quot;Drupal\demo\Form\DemoForm&quot;,
 *       &quot;edit&quot; = &quot;Drupal\demo\Form\DemoForm&quot;,
 *       &quot;delete&quot; = &quot;Drupal\demo\Form\DemoDeleteForm&quot;
 *     }
 *   },
 *   config_prefix = &quot;demo&quot;,
 *   admin_permission = &quot;administer site configuration&quot;,
 *   entity_keys = {
 *     &quot;id&quot; = &quot;id&quot;,
 *     &quot;label&quot; = &quot;name&quot;
 *   },
 *   links = {
 *     &quot;edit-form&quot; = &quot;/admin/structure/demos/{demo}&quot;,
 *     &quot;delete-form&quot; = &quot;/admin/structure/demos/{demo}/delete&quot;
 *   }
 * )
 */
class Demo extends ConfigEntityBase implements DemoInterface {

  /**
   * The ID of the demo.
   *
   * @var string
   */
  public $id;

  /**
   * The demo name.
   *
   * @var string
   */
  public $name;

  /**
   * The demo sex.
   *
   * @var string
   */
  public $sex;

}

?&gt;
</code></pre>
<p>上面定义Entity的方式熟悉吧！对，就是注解annotation。</p>
<p>@ConfigEntityType告诉Drupal这是一个配置实体。参数如下：
1、lable：翻译系统的标签
2、fieldable: 附加字段，配置实体一般为FALSE，内容实体一般为TRUE
3、handlers：管理该实体所需要的类
4、list_builder：提供该实体的管理界面接口
5、config_prefix：配置的前缀，一般用于schema
6、admin_permission：管理员权限
7、entity_keys：主要实体属性的集合
8、links：编辑和删除的路径，在demo.routing.yml中定义</p>
<h3 id="entity-form">三、实体表单(entity form)</h3>
<p>接下来我们来实现在Entity中的定义的表单，如add, edit, delete。</p>
<h4 id="1mkdir-p-srcformtouch-srcformdemoformphp">1、mkdir -p src/Form，并touch src/Form/DemoForm.php。</h4>
<p>在DemoForm主要实现2个方法，form()和save()。</p>
<pre><code class="language-php">&lt;?php

/**
 * @file
 * Contains \Drupal\demo\Form\DemoForm.
 */

namespace Drupal\demo\Form;

use Drupal\Core\Entity\EntityForm;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\EntityTypeInterface;
use Symfony\Component\DependencyInjection\ContainerInterface;
use Drupal\Core\Entity\Query\QueryFactory;
use Drupal\Core\Form\FormStateInterface;

/**
 * Class DemoForm
 *
 * Form class for adding/editing demo config entities.
 */
class DemoForm extends EntityForm {

  /**
   * @param \Drupal\Core\Entity\Query\QueryFactory $entity_query
   *   The entity query.
   */
  public function __construct(QueryFactory $entity_query) {
    $this-&gt;entityQuery = $entity_query;
  }

  /**
   * {@inheritdoc}
   */
  public static function create(ContainerInterface $container) {
    return new static(
      $container-&gt;get('entity.query')
    );
  }

  /**
   * {@inheritdoc}
   */
  public function form(array $form, FormStateInterface $form_state) {
    $form = parent::form($form, $form_state);
    $demo = $this-&gt;entity;

    // Change page title for the edit operation
    if ($this-&gt;operation == 'edit') {
      $form['#title'] = $this-&gt;t('Edit demo: @name', array('@name' =&gt; $demo-&gt;name));
    }

    // The demo name.
    $form['name'] = array(
      '#type' =&gt; 'textfield',
      '#title' =&gt; $this-&gt;t('Name'),
      '#maxlength' =&gt; 255,
      '#default_value' =&gt; $demo-&gt;name,
      '#description' =&gt; $this-&gt;t(&quot;demo name.&quot;),
      '#required' =&gt; TRUE,
    );

    // The unique machine name of the demo.
    $form['id'] = array(
      '#type' =&gt; 'machine_name',
      '#maxlength' =&gt; EntityTypeInterface::BUNDLE_MAX_LENGTH,
      '#default_value' =&gt; $demo-&gt;id,
      '#disabled' =&gt; !$demo-&gt;isNew(),
      '#machine_name' =&gt; array(
        'source' =&gt; array('name'),
        'exists' =&gt; 'demo_load'
      ),
    );

    // The sex.
    $form['sex'] = array(
      '#type' =&gt; 'select',
      '#options' =&gt; array(
        'Man' =&gt; 'Man',
        'Woman' =&gt; 'Woman',
      ),
      '#title' =&gt; $this-&gt;t('Sex'),
      '#maxlength' =&gt; 255,
      '#default_value' =&gt; $demo-&gt;sex,
      '#description' =&gt; $this-&gt;t(&quot;sex&quot;),
      '#required' =&gt; TRUE,
    );
    return $form;
  }

  /**
   * {@inheritdoc}
   */
  public function save(array $form, FormStateInterface $form_state) {
    $demo = $this-&gt;entity;
    $status = $demo-&gt;save();

    if ($status) {
      // Setting the success message.
      drupal_set_message($this-&gt;t('Saved the demo: @label.', array(
        '@label' =&gt; $demo-&gt;name,
      )));
    }
    else {
      drupal_set_message($this-&gt;t('The @label demo was not saved.', array(
        '@label' =&gt; $demo-&gt;name,
      )));
    }

    $form_state-&gt;setRedirect('demo.list');
  }
} 
?&gt;
</code></pre>
<p>如图：</p>
<p><img alt="DemoForm" src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212259_77460.png" /></p>
<h4 id="2touch-srcformdemoformdeletephp">2、touch src/Form/DemoFormDelete.php。</h4>
<p>DemoFormDelete继承<a href="https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Entity%21EntityConfirmFormBase.php/class/EntityConfirmFormBase/8">EntityConfirmFormBase</a>。</p>
<pre><code class="language-php">&lt;?php

/**
 * @file
 * Contains \Drupal\demo\Form\DemoDeleteForm.
 */

namespace Drupal\demo\Form;

use Drupal\Core\Entity\EntityConfirmFormBase;
use Drupal\Core\Url;
use Drupal\Core\Form\FormStateInterface;


/**
 * Form that handles the removal of demo entities.
 */
class DemoDeleteForm extends EntityConfirmFormBase {

  /**
   * {@inheritdoc}
   */
  public function getQuestion() {
    return $this-&gt;t('Are you sure you want to delete this demo: @name?', array('@name' =&gt; $this-&gt;entity-&gt;name));
  }

  /**
   * {@inheritdoc}
   */
  public function getCancelUrl() {
    return new Url('demo.list');
  }

  /**
   * {@inheritdoc}
   */
  public function getConfirmText() {
    return $this-&gt;t('Delete');
  }

  /**
   * {@inheritdoc}
   */
  public function submitForm(array &amp;$form, FormStateInterface $form_state) {
    // Delete and set message
    $this-&gt;entity-&gt;delete();
    drupal_set_message($this-&gt;t('The demo @name has been deleted.', array('@name' =&gt; $this-&gt;entity-&gt;name)));

    $form_state-&gt;setRedirectUrl($this-&gt;getCancelUrl());
  }
}
?&gt;
</code></pre>
<p>如图：
<img alt="FormDelete" src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212429_43428.png" /></p>
<h3 id="list-builder">四、list builder</h3>
<p>接下来就该创建管理界面啦！</p>
<p>在src目录下，touch DemoListBuilder.php</p>
<p>DemoListBuilder继承<a href="https://api.drupal.org/api/drupal/core!lib!Drupal!Core!Config!Entity!ConfigEntityListBuilder.php/class/ConfigEntityListBuilder/8">ConfigEntityListBuilder</a>，实现了三个方法。</p>
<p>1、buildHeader：创建表格header
2、buildRow：创建表格行
3、render：重写表格输出的内容，类似于Drupal7的hook</p>
<pre><code class="language-php">&lt;?php

/**
 * @file
 *
 * Contains Drupal\demo\DemoListBuilder
 */

namespace Drupal\demo;

use Drupal\Core\Config\Entity\ConfigEntityListBuilder;
use Drupal\Core\Entity\EntityInterface;

class DemoListBuilder extends ConfigEntityListBuilder {

  /**
   * {@inheritdoc}
   */
  public function buildHeader() {
    $header['label'] = $this-&gt;t('Name');
    $header['sex'] = $this-&gt;t('Sex');
    return $header + parent::buildHeader();
  }

  /**
   * {@inheritdoc}
   */
  public function buildRow(EntityInterface $entity) {
    // Label
    $row['label'] = $this-&gt;getLabel($entity);
    // Sex
    $row['sex'] = $entity-&gt;sex;
    return $row + parent::buildRow($entity);
  }

  /**
   * {@inheritdoc}
   */
  public function render() {
    $build = parent::render();
    $build['#empty'] = $this-&gt;t('There are no data available.');
    return $build;
  }

}
?&gt;
</code></pre>
<p>如图：
<img alt="ListBuilder" src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212547_35896.png" /></p>
<h3 id="schema">五、schema</h3>
<pre><code class="language-bash">mkdir config/schema
touch demo.schema.yml
</code></pre>
<pre><code class="language-php"># Schema for the configuration files of the Demo module.

demo.demo.*:
  type: mapping
  label: 'Demo'
  mapping:
    id:
      type: string
      label: 'Demo identifier'
    uuid:
      type: string
      label: 'UUID'
    name:
      type: label
      label: 'Name'
    sex:
      type: string
      label: 'Sex'
      translatable: true
</code></pre>
<p>schema的命名规则：</p>
<pre><code class="language-bash">(demo module).(demo configuration entity type).(all demo configuration entities).
</code></pre>
<p>uuid在这里也可以不用定义，drupal默认会添加。</p>
<h3 id="routing">六、routing</h3>
<p>定义一些路由：</p>
<pre><code class="language-bash">demo.list:
  path: '/admin/structure/demos'
  defaults:
    _entity_list: 'demo'
    _title: 'Demos'
  requirements:
    _permission: 'administer site configuration'
demo.add:
  path: '/admin/structure/demos/add'
  defaults:
    _entity_form: 'demo.add'
    _title: 'Add a new demo'
  requirements:
    _permission: 'administer site configuration'
entity.demo.edit_form:
  path: '/admin/structure/demos/{demo}'
  defaults:
    _entity_form: 'demo.edit'
    _title: 'Edit demo'
  requirements:
    _permission: 'administer site configuration'
entity.demo.delete_form:
  path: '/admin/structure/demos/{demo}/delete'
  defaults:
    _entity_form: 'demo.delete'
    _title: 'Delete demo'
  requirements:
    _permission: 'administer site configuration'
</code></pre>
<h3 id="links">七、 links</h3>
<h4 id="1demolinksactionyml">1、显示添加按钮在网页上，需要在demo.links.action.yml中定义</h4>
<pre><code class="language-bash">demo.add:
  route_name: 'demo.add'
  title: 'Add demo'
  appears_on:
    - demo.list
</code></pre>
<p><img alt="demo.add" src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212157_21914.png" /></p>
<h4 id="2adminstructuredemodemolinksmenuyml">2、在admin/structure页面显示demo，需要在demo.links.menu.yml中定义</h4>
<pre><code class="language-bash">demo.list:
  title: Demo
  description: 'Administrator the demo entities'
  parent: system.admin_structure
  route_name: demo.list
</code></pre>
<p>如图：
<img alt="demo.list" src="https://static.verycloud.cn/sites/default/files/pic/image/20151222/20151222212041_77165.png" /></p>
<p>参考文章：
1、http://www.slideshare.net/andypost/d8-entity
2、http://www.sitepoint.com/drupal-8-version-entityfieldquery/
3、https://www.drupal.org/node/1809494</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
