<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"verynil.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="实验系统：CentOS 6.7_x86_64（4.2.3） 实验前提：防火墙和selinux都关闭 实验说明：本实验共有3台主机，拓扑图如下所示  主机说明：manager: 172.16.2.99master: 172.16.115.101备用master: 172.16.115.102也可以加别的slave。 实验软件： mha4mysql-manager-0.56-0.el6.noarch.">
<meta property="og:type" content="article">
<meta property="og:title" content="高性能mysql主从架构及MHA高可用负载均衡">
<meta property="og:url" content="http://verynil.com/2015/11/28/%E9%AB%98%E6%80%A7%E8%83%BDmysql%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%8F%8AMHA%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/index.html">
<meta property="og:site_name" content="Lau&#39;s Blog">
<meta property="og:description" content="实验系统：CentOS 6.7_x86_64（4.2.3） 实验前提：防火墙和selinux都关闭 实验说明：本实验共有3台主机，拓扑图如下所示  主机说明：manager: 172.16.2.99master: 172.16.115.101备用master: 172.16.115.102也可以加别的slave。 实验软件： mha4mysql-manager-0.56-0.el6.noarch.">
<meta property="og:locale">
<meta property="og:image" content="http://images.cnitblog.com/i/609710/201404/192216579327066.png">
<meta property="article:published_time" content="2015-11-28T06:35:42.000Z">
<meta property="article:modified_time" content="2015-12-02T09:20:35.000Z">
<meta property="article:author" content="www.verynil.com">
<meta property="article:tag" content="mysql MHA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://images.cnitblog.com/i/609710/201404/192216579327066.png">

<link rel="canonical" href="http://verynil.com/2015/11/28/%E9%AB%98%E6%80%A7%E8%83%BDmysql%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%8F%8AMHA%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>高性能mysql主从架构及MHA高可用负载均衡 | Lau's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lau's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录生活，分享知识，传播乐趣</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">65</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">81</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="http://verynil.com/2015/11/28/%E9%AB%98%E6%80%A7%E8%83%BDmysql%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%8F%8AMHA%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="www.verynil.com">
      <meta itemprop="description" content="记录生活，分享知识，传播乐趣">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lau's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          高性能mysql主从架构及MHA高可用负载均衡
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-28 14:35:42" itemprop="dateCreated datePublished" datetime="2015-11-28T14:35:42+08:00">2015-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2015-12-02 17:20:35" itemprop="dateModified" datetime="2015-12-02T17:20:35+08:00">2015-12-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>实验系统：CentOS 6.7_x86_64（4.2.3）</p>
<p>实验前提：防火墙和selinux都关闭</p>
<p>实验说明：本实验共有3台主机，拓扑图如下所示</p>
<p><img src="http://images.cnitblog.com/i/609710/201404/192216579327066.png" alt="拓扑图"></p>
<p>主机说明：<br>manager: 172.16.2.99<br>master: 172.16.115.101<br>备用master: 172.16.115.102<br>也可以加别的slave。</p>
<p>实验软件：</p>
<p>mha4mysql-manager-0.56-0.el6.noarch.rpm</p>
<p>mha4mysql-node-0.56-0.el6.noarch.rpm</p>
<p>mysql(mysql-5.5.46-1.el6.remi.x86_64)</p>
<p>###1、安装软件<br>三台机器都需要安装mha4mysql-node, master和slave还需要安装mysql, manager可以不装mysql. 当然manager也可以用slave机器来做。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install mysql mysql-server epel-release -y</span><br><span class="line"></span><br><span class="line">rpm -Uvh mha4mysql-node-0.56-0.el6.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>manager还需要安装mha4mysql-manager.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall mha4mysql-manager-0.56-0.el6.noarch.rpm -y</span><br></pre></td></tr></table></figure>
<p>用localinstall会自动安装依赖。</p>
<p>###2、mysql主从配置</p>
<h4 id="master上编辑-etc-my-cnf，添加配置"><a href="#master上编辑-etc-my-cnf，添加配置" class="headerlink" title="master上编辑/etc/my.cnf，添加配置"></a>master上编辑/etc/my.cnf，添加配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master config</span></span><br><span class="line">server-id = 1</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">log-slave-updates</span><br><span class="line">binlog_do_db = drupal</span><br></pre></td></tr></table></figure>

<h4 id="slave上编辑-etc-my-cnf-添加配置"><a href="#slave上编辑-etc-my-cnf-添加配置" class="headerlink" title="slave上编辑/etc/my.cnf,添加配置"></a>slave上编辑/etc/my.cnf,添加配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># slave config</span></span><br><span class="line">server-id = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">log-slave-updates</span><br><span class="line">binlog_do_db = drupal</span><br></pre></td></tr></table></figure>

<h4 id="创建具有复制权限的用户"><a href="#创建具有复制权限的用户" class="headerlink" title="创建具有复制权限的用户"></a>创建具有复制权限的用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">&#x27;replicate&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h4 id="设置slave"><a href="#设置slave" class="headerlink" title="设置slave"></a>设置slave</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456</span><br><span class="line"></span><br><span class="line">mysql&gt; change master to master_host=<span class="string">&#x27;172.16.115.101&#x27;</span>,master_port=3306,master_user=<span class="string">&#x27;repl&#x27;</span>,master_password=<span class="string">&#x27;123456&#x27;</span>,master_log_file=<span class="string">&#x27;mysql-bin.000001&#x27;</span>,MASTER_LOG_POS=0;</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br></pre></td></tr></table></figure>
<h4 id="查看master-slave配置"><a href="#查看master-slave配置" class="headerlink" title="查看master/slave配置"></a>查看master/slave配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show master status;</span><br><span class="line"></span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">| mysql-bin.000001 |      867 | drupal       |                  |</span><br><span class="line">+------------------+----------+--------------+------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span><br><span class="line"></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.115.101</span><br><span class="line">                  Master_User: repl</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 867</span><br><span class="line">               Relay_Log_File: mysqld-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 1013</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: drupal</span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 867</span><br><span class="line">              Relay_Log_Space: 1170</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>如果Slave_IO_Running和Slave_SQL_Running都是YES，说明slave服务器配置OK。</p>
<p>###3、MHA作用<br>1）从宕机崩溃的master保存二进制日志事件（binlog events）;</p>
<p>2）识别含有最新更新的slave；</p>
<p>3）应用差异的中继日志（relay log）到其他的slave；</p>
<p>4）应用从master保存的二进制日志事件（binlog events）；</p>
<p>5）提升一个slave为新的master；</p>
<p>6）使其他的slave连接新的master进行复制；</p>
<p>MHA软件由两部分组成，Manager工具包和Node工具包，具体的说明如下。</p>
<p>Manager工具包主要包括以下几个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_ssh              检查MHA的SSH配置状况</span><br><span class="line">masterha_check_repl             检查MySQL复制状况</span><br><span class="line">masterha_manger                 启动MHA</span><br><span class="line">masterha_check_status           检测当前MHA运行状态</span><br><span class="line">masterha_master_monitor         检测master是否宕机</span><br><span class="line">masterha_master_switch          控制故障转移（自动或者手动）</span><br><span class="line">masterha_conf_host              添加或删除配置的server信息</span><br></pre></td></tr></table></figure>

<p>Node工具包（这些工具通常由MHA Manager的脚本触发，无需人为操作）主要包括以下几个工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save_binary_logs                保存和复制master的二进制日志</span><br><span class="line">apply_diff_relay_logs           识别差异的中继日志事件并将其差异的事件应用于其他的slave</span><br><span class="line">filter_mysqlbinlog              去除不必要的ROLLBACK事件（MHA已不再使用这个工具）</span><br><span class="line">purge_relay_logs                清除中继日志（不会阻塞SQL线程）</span><br></pre></td></tr></table></figure>

<p>###4、配置MHA<br>####创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 ~]<span class="comment"># vim /etc/masterha/app1.cnf </span></span><br><span class="line"></span><br><span class="line">[server default]</span><br><span class="line">manager_log=/var/<span class="built_in">log</span>/mha/app1/manager.log //设置manager的日志</span><br><span class="line">manager_workdir=/var/<span class="built_in">log</span>/mha/app1.log //设置manager的工作目录</span><br><span class="line">master_binlog_dir=/var/lib/mysql //设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录</span><br><span class="line"></span><br><span class="line">user=repl  //设置监控用户root</span><br><span class="line">password=123456 //设置mysql中root用户的密码，这个密码是前文中创建监控用户的那个密码</span><br><span class="line">ssh_user=root //设置ssh的登录用户名</span><br><span class="line">repl_user=repl //设置复制环境中的复制用户名</span><br><span class="line">repl_password=123456 //设置复制用户的密码</span><br><span class="line">ping_interval=10 //设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行railover</span><br><span class="line"></span><br><span class="line">shutdown_script=<span class="string">&quot;&quot;</span> //设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）</span><br><span class="line">master_ip_online_change_script=<span class="string">&quot;&quot;</span> //设置手动切换时候的切换脚本</span><br><span class="line">report_script=<span class="string">&quot;/usr/bin/masterha_report_script&quot;</span> //设置发生切换后发送的报警的脚本</span><br><span class="line">master_ip_failover_script=<span class="string">&quot;/usr/bin/masterha_ip_failover&quot;</span> //设置自动failover时候的切换脚本</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=172.16.115.101</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=172.16.115.102</span><br><span class="line">candidate_master=1 //设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中时间最新的slave</span><br><span class="line">check_repl_delay=0   //默认情况下如果一个slave落后master 100M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=0,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=1的主机非常有用，因为这个候选主在切换的过程中一定是新的master</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>####设置relay log的清除方式（在每个slave节点上）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.115.102 ~]<span class="comment"># mysql -e &#x27;set global relay_log_purge=0&#x27;</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>MHA在发生切换的过程中，从库的恢复过程中依赖于relay log的相关信息，所以这里要将relay log的自动清除设置为OFF，采用手动清除relay log的方式。在默认情况下，从服务器上的中继日志会在SQL线程执行完毕后被自动删除。但是在MHA环境中，这些中继日志在恢复其他从服务器时可能会被用到，因此需要禁用中继日志的自动删除功能。定期清除中继日志需要考虑到复制延时的问题。在ext3的文件系统下，删除大的文件需要一定的时间，会导致严重的复制延时。为了避免复制延时，需要暂时为中继日志创建硬链接，因为在linux系统中通过硬链接删除大文件速度会很快。（在mysql数据库中，删除大表时，通常也采用建立硬链接的方式）</p>
<p>MHA节点中包含了pure_relay_logs命令工具，它可以为中继日志创建硬链接，执行SET GLOBAL relay_log_purge=1,等待几秒钟以便SQL线程切换到新的中继日志，再执行SET GLOBAL relay_log_purge=0。</p>
<p>pure_relay_logs脚本参数如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">--user mysql                      用户名</span><br><span class="line">--password mysql                  密码</span><br><span class="line">--port                            端口号</span><br><span class="line">--workdir                         指定创建relay <span class="built_in">log</span>的硬链接的位置，默认是/var/tmp，由于系统不同分区创建硬链接文件会失败，故需要执行硬链接具体位置，成功执行脚本后，硬链接的中继日志文件被删除</span><br><span class="line">--disable_relay_log_purge         默认情况下，如果relay_log_purge=1，脚本会什么都不清理，自动退出，通过设定这个参数，当relay_log_purge=1的情况下会将relay_log_purge设置为0。清理relay <span class="built_in">log</span>之后，最后将参数设置为OFF。</span><br></pre></td></tr></table></figure>

<p>####设置定期清理relay脚本（两台slave服务器）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.115.102 ~]<span class="comment"># cat purge_relay_log.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">user=root</span><br><span class="line">passwd=123456</span><br><span class="line">port=3306</span><br><span class="line">log_dir=<span class="string">&#x27;/var/log/masterha&#x27;</span></span><br><span class="line">work_dir=<span class="string">&#x27;/var/lib/mysql&#x27;</span></span><br><span class="line">purge=<span class="string">&#x27;/usr/local/bin/purge_relay_logs&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$log_dir</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   mkdir <span class="variable">$log_dir</span> -p</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$purge</span> --user=<span class="variable">$user</span> --password=<span class="variable">$passwd</span> --disable_relay_log_purge --port=<span class="variable">$port</span> --workdir=<span class="variable">$work_dir</span> &gt;&gt; <span class="variable">$log_dir</span>/purge_relay_logs.log 2&gt;&amp;1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>添加到crontab定期执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.115.102 ~]<span class="comment"># crontab -l</span></span><br><span class="line">0 4 * * * /bin/bash /root/purge_relay_log.sh</span><br></pre></td></tr></table></figure>

<p>####purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.115.102 ~]<span class="comment"># purge_relay_logs --user=root --password=123456 --port=3306 -disable_relay_log_purge --workdir=/data/</span></span><br><span class="line">2014-04-20 15:47:24: purge_relay_logs script started.</span><br><span class="line"> Found relay_log.info: /data/mysql/relay-log.info</span><br><span class="line"> Removing hard linked relay <span class="built_in">log</span> files server03-relay-bin* under /data/.. <span class="keyword">done</span>.</span><br><span class="line"> Current relay <span class="built_in">log</span> file: /data/mysql/server03-relay-bin.000002</span><br><span class="line"> Archiving unused relay <span class="built_in">log</span> files (up to /data/mysql/server03-relay-bin.000001) ...</span><br><span class="line"> Creating hard link <span class="keyword">for</span> /data/mysql/server03-relay-bin.000001 under /data//server03-relay-bin.000001 .. ok.</span><br><span class="line"> Creating hard links <span class="keyword">for</span> unused relay <span class="built_in">log</span> files completed.</span><br><span class="line"> Executing SET GLOBAL relay_log_purge=1; FLUSH LOGS; sleeping a few seconds so that SQL thread can delete older relay <span class="built_in">log</span> files (<span class="keyword">if</span> it keeps up); SET GLOBAL relay_log_purge=0; .. ok.</span><br><span class="line"> Removing hard linked relay <span class="built_in">log</span> files server03-relay-bin* under /data/.. <span class="keyword">done</span>.</span><br><span class="line">2014-04-20 15:47:27: All relay <span class="built_in">log</span> purging operations succeeded.</span><br></pre></td></tr></table></figure>

<p>###5、SSH配置<br>要想MHA顺利执行各项任务，还得打通每台机器的SSH。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 app1]<span class="comment"># ssh-keygen -t rsa</span></span><br><span class="line">[root@172.16.2.99 app1]<span class="comment"># ssh-copy-id -i .ssh/id_rsa.pub root@172.16.115.101</span></span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<p>记住，每台机器都要跟别的机器打通SSH。</p>
<p>检查MHA Manger到所有MHA Node的SSH连接状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 app1]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span></span><br><span class="line">Wed Dec  2 14:42:39 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug] </span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug]  Connecting via SSH from root@172.16.115.101(172.16.115.101:22) to root@172.16.115.102(172.16.115.102:22)..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug]   ok.</span><br><span class="line">Wed Dec  2 14:42:40 2015 - [debug] </span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug]  Connecting via SSH from root@172.16.115.102(172.16.115.102:22) to root@172.16.115.101(172.16.115.101:22)..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug]   ok.</span><br><span class="line">Wed Dec  2 14:42:40 2015 - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure>
<p>可以看见各个节点ssh验证都是ok的。</p>
<p>###6、检查整个复制环境状况<br>通过masterha_check_repl脚本查看整个集群的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 app1]<span class="comment"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span></span><br><span class="line">Wed Dec  2 14:42:39 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug] </span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug]  Connecting via SSH from root@172.16.115.101(172.16.115.101:22) to root@172.16.115.102(172.16.115.102:22)..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug]   ok.</span><br><span class="line">Wed Dec  2 14:42:40 2015 - [debug] </span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug]  Connecting via SSH from root@172.16.115.102(172.16.115.102:22) to root@172.16.115.101(172.16.115.101:22)..</span><br><span class="line">Wed Dec  2 14:42:39 2015 - [debug]   ok.</span><br><span class="line">Wed Dec  2 14:42:40 2015 - [info] All SSH connection tests passed successfully.</span><br><span class="line">[root@utn-cz-1-1-s16h2 app1.log]<span class="comment"># masterha_check_repl --conf=/etc/masterha/app1.cnf  </span></span><br><span class="line">Wed Dec  2 14:43:49 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  2 14:43:49 2015 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  2 14:43:49 2015 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  2 14:43:49 2015 - [info] MHA::MasterMonitor version 0.56.</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info] GTID failover mode = 0</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info] Dead Servers:</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info] Alive Servers:</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info]   172.16.115.101(172.16.115.101:3306)</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info]   172.16.115.102(172.16.115.102:3306)</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info] Alive Slaves:</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info]   172.16.115.102(172.16.115.102:3306)  Version=5.5.46-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info]     Replicating from 172.16.115.101(172.16.115.101:3306)</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info] Current Alive Master: 172.16.115.101(172.16.115.101:3306)</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info] Checking slave configurations..</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info]  read_only=1 is not <span class="built_in">set</span> on slave 172.16.115.102(172.16.115.102:3306).</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [warning]  relay_log_purge=0 is not <span class="built_in">set</span> on slave 172.16.115.102(172.16.115.102:3306).</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info] Checking replication filtering settings..</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info]  binlog_do_db= drupal, binlog_ignore_db= </span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info]  Replication filtering check ok.</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info] GTID (with auto-pos) is not supported</span><br><span class="line">Wed Dec  2 14:43:50 2015 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  2 14:43:51 2015 - [info] All SSH connection tests passed successfully.</span><br><span class="line">Wed Dec  2 14:43:51 2015 - [info] Checking MHA Node version..</span><br><span class="line">Wed Dec  2 14:43:51 2015 - [info]  Version check ok.</span><br><span class="line">Wed Dec  2 14:43:51 2015 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Dec  2 14:43:51 2015 - [info] HealthCheck: SSH to 172.16.115.101 is reachable.</span><br><span class="line">Wed Dec  2 14:43:51 2015 - [info] Master MHA Node version is 0.56.</span><br><span class="line">Wed Dec  2 14:43:51 2015 - [info] Checking recovery script configurations on 172.16.115.101(172.16.115.101:3306)..</span><br><span class="line">Wed Dec  2 14:43:51 2015 - [info]   Executing <span class="built_in">command</span>: save_binary_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --start_pos=4 --binlog_dir=/var/lib/mysql --output_file=/var/tmp/save_binary_logs_test --manager_version=0.56 --start_file=mysql-bin.000021 </span><br><span class="line">Wed Dec  2 14:43:51 2015 - [info]   Connecting to root@172.16.115.101(172.16.115.101:22).. </span><br><span class="line">  Creating /var/tmp <span class="keyword">if</span> not exists..    ok.</span><br><span class="line">  Checking output directory is accessible or not..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /var/lib/mysql, up to mysql-bin.000021</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info] Binlog setting check <span class="keyword">done</span>.</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --slave_user=<span class="string">&#x27;repl&#x27;</span> --slave_host=172.16.115.102 --slave_ip=172.16.115.102 --slave_port=3306 --workdir=/var/tmp --target_version=5.5.46-log --manager_version=0.56 --relay_log_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info]   Connecting to root@172.16.115.102(172.16.115.102:22).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to mysqld-relay-bin.000022</span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/mysqld-relay-bin.000022</span><br><span class="line">    Testing mysql connection and privileges.. <span class="keyword">done</span>.</span><br><span class="line">    Testing mysqlbinlog output.. <span class="keyword">done</span>.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. <span class="keyword">done</span>.</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info] Slaves settings check <span class="keyword">done</span>.</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info] </span><br><span class="line">172.16.115.101(172.16.115.101:3306) (current master)</span><br><span class="line"> +--172.16.115.102(172.16.115.102:3306)</span><br><span class="line"></span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info] Checking replication health on 172.16.115.102..</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info]  ok.</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info]   /usr/bin/masterha_ip_failover --<span class="built_in">command</span>=status --ssh_user=root --orig_master_host=172.16.115.101 --orig_master_ip=172.16.115.101 --orig_master_port=3306 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:0 down==/sbin/ifconfig eth0:0 172.16.115.200/24===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info]  OK.</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Dec  2 14:43:52 2015 - [info] Got <span class="built_in">exit</span> code 0 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br></pre></td></tr></table></figure>

<p>###7、检查MHA Manager的状态<br>通过master_check_status脚本查看Manager的状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">app1 is stopped(2:NOT_RUNNING).</span><br></pre></td></tr></table></figure>
<p>注意：如果正常，会显示”PING_OK”，否则会显示”NOT_RUNNING”，这代表MHA监控没有开启。</p>
<p>###8、开启MHA Manager监控</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 ~]<span class="comment"># nohup masterha_manager --conf=/etc/masterha/app1.cnf --ignore_last_failover &gt; /var/log/mha/app1/manager.log &lt; /dev/null 2&gt;&amp;1 &amp;</span></span><br><span class="line">[1] 7303</span><br></pre></td></tr></table></figure>

<p>启动参数介绍：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--remove_dead_master_conf      该参数代表当发生主从切换后，老的主库的ip将会从配置文件中移除。</span><br><span class="line">--manger_log                            日志存放位置</span><br><span class="line">--ignore_last_failover                 在缺省情况下，如果MHA检测到连续发生宕机，且两次宕机间隔不足8小时的话，则不会进行Failover，之所以这样限制是为了避免ping-pong效应。该参数代表忽略上次MHA触发切换产生的文件，默认情况下，MHA发生切换后会在日志目录，也就是上面我设置的/data产生app1.failover.complete文件，下次再次切换的时候如果发现该目录下存在该文件将不允许触发切换，除非在第一次切换后收到删除该文件，为了方便，这里设置为--ignore_last_failover。</span><br></pre></td></tr></table></figure>

<p>查看MHA Manager监控是否正常：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">app1 (pid:20386) is running(0:PING_OK), master:172.16.115.101</span><br></pre></td></tr></table></figure>

<p>可以看见已经在监控了，而且master的主机为172.16.115.101</p>
<p>###9、查看启动日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 ~]<span class="comment">#  cat /var/log/mha/app1/manager.log</span></span><br><span class="line">Wed Dec  2 14:46:37 2015 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Dec  2 14:46:37 2015 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  2 14:46:37 2015 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Dec  2 14:46:37 2015 - [info] MHA::MasterMonitor version 0.56.</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info] GTID failover mode = 0</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info] Dead Servers:</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info] Alive Servers:</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info]   172.16.115.101(172.16.115.101:3306)</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info]   172.16.115.102(172.16.115.102:3306)</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info] Alive Slaves:</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info]   172.16.115.102(172.16.115.102:3306)  Version=5.5.46-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info]     Replicating from 172.16.115.101(172.16.115.101:3306)</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is <span class="built_in">set</span>)</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info] Current Alive Master: 172.16.115.101(172.16.115.101:3306)</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info] Checking slave configurations..</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info]  read_only=1 is not <span class="built_in">set</span> on slave 172.16.115.102(172.16.115.102:3306).</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [warning]  relay_log_purge=0 is not <span class="built_in">set</span> on slave 172.16.115.102(172.16.115.102:3306).</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info] Checking replication filtering settings..</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info]  binlog_do_db= drupal, binlog_ignore_db= </span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info]  Replication filtering check ok.</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info] GTID (with auto-pos) is not supported</span><br><span class="line">Wed Dec  2 14:46:38 2015 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info] All SSH connection tests passed successfully.</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info] Checking MHA Node version..</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info]  Version check ok.</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info] HealthCheck: SSH to 172.16.115.101 is reachable.</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info] Master MHA Node version is 0.56.</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info] Checking recovery script configurations on 172.16.115.101(172.16.115.101:3306)..</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info]   Executing <span class="built_in">command</span>: save_binary_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --start_pos=4 --binlog_dir=/var/lib/mysql --output_file=/var/tmp/save_binary_logs_test --manager_version=0.56 --start_file=mysql-bin.000021 </span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info]   Connecting to root@172.16.115.101(172.16.115.101:22).. </span><br><span class="line">  Creating /var/tmp <span class="keyword">if</span> not exists..    ok.</span><br><span class="line">  Checking output directory is accessible or not..</span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /var/lib/mysql, up to mysql-bin.000021</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info] Binlog setting check <span class="keyword">done</span>.</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info] Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs --<span class="built_in">command</span>=<span class="built_in">test</span> --slave_user=<span class="string">&#x27;repl&#x27;</span> --slave_host=172.16.115.102 --slave_ip=172.16.115.102 --slave_port=3306 --workdir=/var/tmp --target_version=5.5.46-log --manager_version=0.56 --relay_log_info=/var/lib/mysql/relay-log.info  --relay_dir=/var/lib/mysql/  --slave_pass=xxx</span><br><span class="line">Wed Dec  2 14:46:39 2015 - [info]   Connecting to root@172.16.115.102(172.16.115.102:22).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /var/lib/mysql/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /var/lib/mysql, up to mysqld-relay-bin.000022</span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /var/lib/mysql/mysqld-relay-bin.000022</span><br><span class="line">    Testing mysql connection and privileges.. <span class="keyword">done</span>.</span><br><span class="line">    Testing mysqlbinlog output.. <span class="keyword">done</span>.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. <span class="keyword">done</span>.</span><br><span class="line">Wed Dec  2 14:46:40 2015 - [info] Slaves settings check <span class="keyword">done</span>.</span><br><span class="line">Wed Dec  2 14:46:40 2015 - [info] </span><br><span class="line">172.16.115.101(172.16.115.101:3306) (current master)</span><br><span class="line"> +--172.16.115.102(172.16.115.102:3306)</span><br><span class="line"></span><br><span class="line">Wed Dec  2 14:46:40 2015 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Wed Dec  2 14:46:40 2015 - [info]   /usr/bin/masterha_ip_failover --<span class="built_in">command</span>=status --ssh_user=root --orig_master_host=172.16.115.101 --orig_master_ip=172.16.115.101 --orig_master_port=3306 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/sbin/ifconfig eth0:0 down==/sbin/ifconfig eth0:0 172.16.115.200/24===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Wed Dec  2 14:46:40 2015 - [info]  OK.</span><br><span class="line">Wed Dec  2 14:46:40 2015 - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Dec  2 14:46:40 2015 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Wed Dec  2 14:46:40 2015 - [warning] secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.</span><br><span class="line">Wed Dec  2 14:46:40 2015 - [info] Starting ping health check on 172.16.115.101(172.16.115.101:3306)..</span><br><span class="line">Wed Dec  2 14:46:40 2015 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn<span class="string">&#x27;t respond..</span></span><br></pre></td></tr></table></figure>

<p>###10、配置VIP</p>
<p>我们采用脚本的方式去配置vip</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 ~]<span class="comment">#  vim /usr/bin/masterha_ip_failover</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">&#x27;all&#x27;</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">    <span class="variable">$command</span>,          <span class="variable">$ssh_user</span>,        <span class="variable">$orig_master_host</span>, <span class="variable">$orig_master_ip</span>,</span><br><span class="line">    <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_master_ip</span>,    <span class="variable">$new_master_port</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">my <span class="variable">$vip</span> = <span class="string">&#x27;172.16.115.200/24&#x27;</span>;</span><br><span class="line">my <span class="variable">$key</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">my <span class="variable">$ssh_start_vip</span> = <span class="string">&quot;/sbin/ifconfig eth0:<span class="variable">$key</span> <span class="variable">$vip</span>&quot;</span>;</span><br><span class="line">my <span class="variable">$ssh_stop_vip</span> = <span class="string">&quot;/sbin/ifconfig eth0:<span class="variable">$key</span> down&quot;</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">&#x27;command=s&#x27;</span>          =&gt; \<span class="variable">$command</span>,</span><br><span class="line">    <span class="string">&#x27;ssh_user=s&#x27;</span>         =&gt; \<span class="variable">$ssh_user</span>,</span><br><span class="line">    <span class="string">&#x27;orig_master_host=s&#x27;</span> =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">    <span class="string">&#x27;orig_master_ip=s&#x27;</span>   =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">    <span class="string">&#x27;orig_master_port=i&#x27;</span> =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">    <span class="string">&#x27;new_master_host=s&#x27;</span>  =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">    <span class="string">&#x27;new_master_ip=s&#x27;</span>    =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">    <span class="string">&#x27;new_master_port=i&#x27;</span>  =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;\n\nIN SCRIPT TEST====<span class="variable">$ssh_stop_vip</span>==<span class="variable">$ssh_start_vip</span>===\n\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">&quot;stop&quot;</span> || <span class="variable">$command</span> eq <span class="string">&quot;stopssh&quot;</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        my <span class="variable">$exit_code</span> = 1;</span><br><span class="line">        <span class="built_in">eval</span> &#123;</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;Disabling the VIP on old master: <span class="variable">$orig_master_host</span> \n&quot;</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            <span class="variable">$exit_code</span> = 0;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">            warn <span class="string">&quot;Got Error: <span class="variable">$@</span>\n&quot;</span>;</span><br><span class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">&quot;start&quot;</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        my <span class="variable">$exit_code</span> = 10;</span><br><span class="line">        <span class="built_in">eval</span> &#123;</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;Enabling the VIP - <span class="variable">$vip</span> on the new master - <span class="variable">$new_master_host</span> \n&quot;</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            <span class="variable">$exit_code</span> = 0;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">            warn <span class="variable">$@</span>;</span><br><span class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">&quot;status&quot;</span> ) &#123;</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Checking the Status of the script.. OK \n&quot;</span>;</span><br><span class="line">        <span class="built_in">exit</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="built_in">exit</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub <span class="function"><span class="title">start_vip</span></span>() &#123;</span><br><span class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$new_master_host</span> \&quot; <span class="variable">$ssh_start_vip</span> \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line">sub <span class="function"><span class="title">stop_vip</span></span>() &#123;</span><br><span class="line">     <span class="built_in">return</span> 0  unless  (<span class="variable">$ssh_user</span>);</span><br><span class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$orig_master_host</span> \&quot; <span class="variable">$ssh_stop_vip</span> \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">    <span class="built_in">print</span></span><br><span class="line">    <span class="string">&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip </span></span><br><span class="line"><span class="string">            --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>###11、邮件发送脚本send_report </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">&#x27;all&#x27;</span>;</span><br><span class="line">use Mail::Sender;</span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( <span class="variable">$dead_master_host</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_slave_hosts</span>, <span class="variable">$subject</span>, <span class="variable">$body</span> );</span><br><span class="line">my <span class="variable">$smtp</span>=<span class="string">&#x27;smtp.163.com&#x27;</span>;</span><br><span class="line">my <span class="variable">$mail_from</span>=<span class="string">&#x27;services@163.com&#x27;</span>;</span><br><span class="line">my <span class="variable">$mail_user</span>=<span class="string">&#x27;services@163.com&#x27;</span>;</span><br><span class="line">my <span class="variable">$mail_pass</span>=<span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">my <span class="variable">$mail_to</span>=[<span class="string">&#x27;xxx@xxx.cn&#x27;</span>];</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">&#x27;orig_master_host=s&#x27;</span> =&gt; \<span class="variable">$dead_master_host</span>,</span><br><span class="line">  <span class="string">&#x27;new_master_host=s&#x27;</span>  =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">&#x27;new_slave_hosts=s&#x27;</span>  =&gt; \<span class="variable">$new_slave_hosts</span>,</span><br><span class="line">  <span class="string">&#x27;subject=s&#x27;</span>          =&gt; \<span class="variable">$subject</span>,</span><br><span class="line">  <span class="string">&#x27;body=s&#x27;</span>             =&gt; \<span class="variable">$body</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">mailToContacts(<span class="variable">$smtp</span>,<span class="variable">$mail_from</span>,<span class="variable">$mail_user</span>,<span class="variable">$mail_pass</span>,<span class="variable">$mail_to</span>,<span class="variable">$subject</span>,<span class="variable">$body</span>);</span><br><span class="line"></span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( <span class="variable">$smtp</span>, <span class="variable">$mail_from</span>, <span class="variable">$user</span>, <span class="variable">$passwd</span>, <span class="variable">$mail_to</span>, <span class="variable">$subject</span>, <span class="variable">$msg</span> ) = @_;</span><br><span class="line">    open my <span class="variable">$DEBUG</span>, <span class="string">&quot;&gt; /tmp/monitormail.log&quot;</span></span><br><span class="line">        or die <span class="string">&quot;Can&#x27;t open the debug      file:$!\n&quot;</span>;</span><br><span class="line">    my <span class="variable">$sender</span> = new Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">&#x27;text/plain; charset=utf-8&#x27;</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">        smtp        =&gt; <span class="variable">$smtp</span>,</span><br><span class="line">        from        =&gt; <span class="variable">$mail_from</span>,</span><br><span class="line">        auth        =&gt; <span class="string">&#x27;LOGIN&#x27;</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">        authid      =&gt; <span class="variable">$user</span>,</span><br><span class="line">        authpwd     =&gt; <span class="variable">$passwd</span>,</span><br><span class="line">        to          =&gt; <span class="variable">$mail_to</span>,</span><br><span class="line">        subject     =&gt; <span class="variable">$subject</span>,</span><br><span class="line">        debug       =&gt; <span class="variable">$DEBUG</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sender</span>-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; <span class="variable">$msg</span>,</span><br><span class="line">            debug =&gt; <span class="variable">$DEBUG</span></span><br><span class="line">        &#125;</span><br><span class="line">    ) or <span class="built_in">print</span> <span class="variable">$Mail</span>::Sender::Error;</span><br><span class="line">    <span class="built_in">return</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0;</span><br></pre></td></tr></table></figure>


<p>###12、测试<br>1.主库断电<br>2.主库断网<br>3.主库重启<br>4.主库关机<br>以上情况都测试过都能自动切换~<br>请看日志分析切换过程  </p>
<p>###13、主库模拟故障后的恢复  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@172.16.2.99 app1]<span class="comment"># grep -i &quot;All other slaves should start&quot; manager.log </span></span><br><span class="line">Mon Apr 21 22:28:33 2014 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;172.16.115.102&#x27;</span>, MASTER_PORT=3306, MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000022&#x27;</span>, MASTER_LOG_POS=506716, MASTER_USER=<span class="string">&#x27;repl&#x27;</span>, MASTER_PASSWORD=<span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">[root@192.168.0.20 app1]<span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p>然后再就得主库里执行下,再start slave ,然后就得主库就变为了新的主库的从库了。<br>记得看下show slave status\G;  </p>
<p>###14、报错记录总结<br>摘抄自google.</p>
<p>####报错记录1：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@data01 ~]<span class="comment"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Tue Apr 7 22:31:06 2015 - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Tue Apr 7 22:31:07 2015 - [info] Reading application default configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Tue Apr 7 22:31:07 2015 - [info] Reading server configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Tue Apr 7 22:31:07 2015 - [info] MHA::MasterMonitor version 0.56.</span><br><span class="line">Tue Apr 7 22:31:07 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/Server.pm,ln303]  Getting relay <span class="built_in">log</span> directory orcurrent relay logfile from replication table failed on192.168.52.130(192.168.52.130:3306)!</span><br><span class="line">Tue Apr 7 22:31:07 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pmline 315</span><br><span class="line">Tue Apr 7 22:31:07 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Tue Apr 7 22:31:07 2015 - [info] Got <span class="built_in">exit</span> code 1 (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@data01 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>解决办法：在192.168.52.130上面，vim /etc/my.cnf，在里面添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">relay-log=/home/data/mysql/binlog/mysql-relay-bin</span><br></pre></td></tr></table></figure>

<p>然后重启mysql，再去重新设置slave连接。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STOP SLAVE;</span><br><span class="line">RESET SLAVE;</span><br><span class="line">CHANGE MASTER TOMASTER_HOST=<span class="string">&#x27;192.168.52.129&#x27;</span>,MASTER_USER=<span class="string">&#x27;repl&#x27;</span>,MASTER_PASSWORD=<span class="string">&#x27;repl_1234&#x27;</span>,MASTER_LOG_FILE=<span class="string">&#x27;mysql-bin.000178&#x27;</span>,MASTER_LOG_POS=459;</span><br><span class="line">START SLAVE;</span><br></pre></td></tr></table></figure>

<p>Ok，搞定了。</p>
<p>####报错记录2：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@data01 perl]<span class="comment"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Thu Apr 9 00:54:32 2015 - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Apr 9 00:54:32 2015 - [info] Reading application default configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr 9 00:54:32 2015 - [info] Reading server configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr 9 00:54:32 2015 - [info] MHA::MasterMonitor version 0.56.</span><br><span class="line">Thu Apr 9 00:54:32 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/Server.pm,ln306]  Getting relay <span class="built_in">log</span> directory orcurrent relay logfile from replication table failed on 192.168.52.130(192.168.52.130:3306)!</span><br><span class="line">Thu Apr 9 00:54:32 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at/usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pm line 315</span><br><span class="line">Thu Apr 9 00:54:32 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr 9 00:54:32 2015 - [info] Got <span class="built_in">exit</span> code 1 (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@data01 perl]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>解决方法：<br>/etc/masterha/app1.cnf文件里面的参数配置，user和repl_user都是mysql账号，需要创建好，这里是只创建了repl_user而没有创建好user账号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user=manager</span><br><span class="line">password=manager_1234</span><br><span class="line">repl_user=repl</span><br><span class="line">repl_password=repl_1234</span><br></pre></td></tr></table></figure>

<p>在mysql节点上，建立允许manager 访问数据库的“ manager manager ”账户，主要用于SHOW SLAVESTATUS,RESET SLAVE; 所以需要执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT SUPER,RELOAD,REPLICATIONCLIENT,SELECT ON *.* TO manager@<span class="string">&#x27;192.168.52.%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;manager_1234&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>####错误记录3：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@oraclem1 ~]<span class="comment">#  masterha_check_repl--conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Thu Apr 9 23:09:05 2015 - [warning] Global configuration file/etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Apr 9 23:09:05 2015 - [info] Reading application default configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr 9 23:09:05 2015 - [info] Reading server configuration from/etc/masterha/app1.cnf..</span><br><span class="line">Thu Apr 9 23:09:05 2015 - [info] MHA::MasterMonitor version 0.56.</span><br><span class="line">Thu Apr 9 23:09:05 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/ServerManager.pm,ln781] Multi-master configuration is detected, but two or more masters areeither writable (read-only is not <span class="built_in">set</span>) or dead! Check configurations fordetails. Master configurations are as below:</span><br><span class="line">Master 192.168.52.130(192.168.52.130:3306),replicating from 192.168.52.129(192.168.52.129:3306)</span><br><span class="line">Master 192.168.52.129(192.168.52.129:3306),replicating from 192.168.52.130(192.168.52.130:3306)</span><br><span class="line"> </span><br><span class="line">Thu Apr 9 23:09:05 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm line 326</span><br><span class="line">Thu Apr 9 23:09:05 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr 9 23:09:05 2015 - [info] Got <span class="built_in">exit</span> code 1 (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br><span class="line">[root@oraclem1 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> global read_only=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<p>####报错记录4：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Thu Apr 9 23:54:32 2015 - [info] Checking SSH publickey authentication andchecking recovery script configurations on all alive slave servers..</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [info]  Executing <span class="built_in">command</span> : apply_diff_relay_logs --<span class="built_in">command</span>=test--slave_user=<span class="string">&#x27;manager&#x27;</span> --slave_host=192.168.52.130 --slave_ip=192.168.52.130--slave_port=3306 --workdir=/var/tmp --target_version=5.6.12-log--manager_version=0.56 --relay_dir=/home/data/mysql/data--current_relay_log=mysqld-relay-bin.000011 --slave_pass=xxx</span><br><span class="line">Thu Apr 9 23:54:32 2015 - [info]  Connecting to root@192.168.52.130(192.168.52.130:22)..</span><br><span class="line">Can<span class="string">&#x27;t exec &quot;mysqlbinlog&quot;: No suchfile or directory at /usr/local/share/perl5/MHA/BinlogManager.pm line 106.</span></span><br><span class="line"><span class="string">mysqlbinlog version command failed with rc1:0, please verify PATH, LD_LIBRARY_PATH, and client options</span></span><br><span class="line"><span class="string"> at/usr/local/bin/apply_diff_relay_logs line 493</span></span><br><span class="line"><span class="string">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln205] Slaves settings check failed!</span></span><br><span class="line"><span class="string">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln413] Slave configuration failed.</span></span><br><span class="line"><span class="string">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/local/bin/masterha_check_repl line 48</span></span><br><span class="line"><span class="string">Thu Apr 9 23:54:32 2015 - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span></span><br><span class="line"><span class="string">Thu Apr 9 23:54:32 2015 - [info] Got exit code 1 (Not master dead).</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">MySQL Replication Health is NOT OK!</span></span><br><span class="line"><span class="string">[root@oraclem1 ~]#</span></span><br></pre></td></tr></table></figure>

<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@data02 ~]<span class="comment"># type mysqlbinlog</span></span><br><span class="line">mysqlbinlog is/usr/<span class="built_in">local</span>/mysql/bin/mysqlbinlog</span><br><span class="line">[root@data02 ~]<span class="comment">#</span></span><br><span class="line">[root@data02 ~]<span class="comment"># ln -s/usr/local/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog</span></span><br></pre></td></tr></table></figure>

<p>####报错记录5：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Thu Apr 9 23:57:24 2015 - [info]  Connecting to root@192.168.52.130(192.168.52.130:22)..</span><br><span class="line"> Checking slave recovery environment settings..</span><br><span class="line">   Relay <span class="built_in">log</span> found at /home/data/mysql/data, up to mysqld-relay-bin.000013</span><br><span class="line">   Temporary relay <span class="built_in">log</span> file is /home/data/mysql/data/mysqld-relay-bin.000013</span><br><span class="line">   Testing mysql connection and privileges..sh: mysql: <span class="built_in">command</span> not found</span><br><span class="line">mysql <span class="built_in">command</span> failed with rc 127:0!</span><br><span class="line"> at/usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 375</span><br><span class="line">         main::check()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 497</span><br><span class="line">         <span class="built_in">eval</span>&#123;...&#125; called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 475</span><br><span class="line">         main::main()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 120</span><br><span class="line">Thu Apr 9 23:57:24 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln205] Slaves settings check failed!</span><br><span class="line">Thu Apr 9 23:57:24 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln413] Slave configuration failed.</span><br><span class="line">Thu Apr 9 23:57:24 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln424] Error happened on checking configurations.  at /usr/<span class="built_in">local</span>/bin/masterha_check_repl line 48</span><br><span class="line">Thu Apr 9 23:57:24 2015 - [error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm,ln523] Error happened on monitoring servers.</span><br><span class="line">Thu Apr 9 23:57:24 2015 - [info] Got <span class="built_in">exit</span> code 1 (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br></pre></td></tr></table></figure>

<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/mysql/bin/mysql/usr/bin/mysql</span><br></pre></td></tr></table></figure>
<p>####报错记录6：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Fri Apr 10 00:58:36 2015 - [info]   Executing <span class="built_in">command</span> : apply_diff_relay_logs--command=<span class="built_in">test</span> --slave_user=<span class="string">&#x27;manager&#x27;</span> --slave_host=192.168.52.130--slave_ip=192.168.52.130 --slave_port=3306 --workdir=/var/tmp--target_version=5.6.12-log --manager_version=0.56--relay_dir=/home/data/mysql/data--current_relay_log=mysqld-relay-bin.000011 --slave_pass=xxx</span><br><span class="line">Fri Apr 10 00:58:36 2015 - [info]   Connecting to root@192.168.52.130(192.168.52.130:22)..</span><br><span class="line"> Checking slave recovery environment settings..</span><br><span class="line">   Relay <span class="built_in">log</span> found at /home/data/mysql/data, up to mysqld-relay-bin.000013</span><br><span class="line">   Temporary relay <span class="built_in">log</span> file is/home/data/mysql/data/mysqld-relay-bin.000013</span><br><span class="line">   Testing mysql connection and privileges..Warning: Using a password onthe <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">ERROR 1142 (42000) at line 1: CREATEcommand denied to user <span class="string">&#x27;manager&#x27;</span>@<span class="string">&#x27;192.168.52.130&#x27;</span> <span class="keyword">for</span> table<span class="string">&#x27;apply_diff_relay_logs_test&#x27;</span></span><br><span class="line">mysql <span class="built_in">command</span> failed with rc 1:0!</span><br><span class="line"> at/usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 375</span><br><span class="line">         main::check()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 497</span><br><span class="line">         <span class="built_in">eval</span>&#123;...&#125; called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 475</span><br><span class="line">         main::main()called at /usr/<span class="built_in">local</span>/bin/apply_diff_relay_logs line 120</span><br><span class="line">Fri Apr 10 00:58:37 2015 -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln205] Slaves settingscheck failed!</span><br><span class="line">Fri Apr 10 00:58:37 2015 -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln413] Slave configurationfailed.</span><br><span class="line">Fri Apr 10 00:58:37 2015 -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln424] Error happened onchecking configurations.  at/usr/<span class="built_in">local</span>/bin/masterha_check_repl line 48</span><br><span class="line">Fri Apr 10 00:58:37 2015 -[error][/usr/<span class="built_in">local</span>/share/perl5/MHA/MasterMonitor.pm, ln523] Error happened onmonitoring servers.</span><br><span class="line">Fri Apr 10 00:58:37 2015 - [info] Got exitcode 1 (Not master dead).</span><br><span class="line"> </span><br><span class="line">MySQL Replication Health is NOT OK!</span><br></pre></td></tr></table></figure>

<p>解决办法：<br>执行如下授权语句sql：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT CREATE,INSERT,UPDATE,DELETE,DROP ON*.* TO manager@<span class="string">&#x27;192.168.52.%&#x27;</span>;</span><br></pre></td></tr></table></figure>


<p>####其他<br>另外，如果nohup masterha_manager执行不了，请检查master和slave是否配置正确。可以通过</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master to master_host=<span class="string">&#x27;172.16.115.101&#x27;</span>,master_port=3306,master_user=<span class="string">&#x27;repl&#x27;</span>,master_password=<span class="string">&#x27;123456&#x27;</span>,master_log_file=<span class="string">&#x27;mysql-bin.000001&#x27;</span>,MASTER_LOG_POS=0;</span><br></pre></td></tr></table></figure>

<p>重新设置slave。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql-MHA/" rel="tag"># mysql MHA</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2015/11/27/%E4%BD%BF%E7%94%A8gdb%E8%B0%83%E8%AF%95php-fpm/" rel="prev" title="使用gdb调试php-fpm">
      <i class="fa fa-chevron-left"></i> 使用gdb调试php-fpm
    </a></div>
      <div class="post-nav-item">
    <a href="/2015/12/11/Drupal8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4-Namespace/" rel="next" title="Drupal8命名空间(Namespace)">
      Drupal8命名空间(Namespace) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#master%E4%B8%8A%E7%BC%96%E8%BE%91-etc-my-cnf%EF%BC%8C%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="nav-number">1.</span> <span class="nav-text">master上编辑&#x2F;etc&#x2F;my.cnf，添加配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#slave%E4%B8%8A%E7%BC%96%E8%BE%91-etc-my-cnf-%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">slave上编辑&#x2F;etc&#x2F;my.cnf,添加配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%85%B7%E6%9C%89%E5%A4%8D%E5%88%B6%E6%9D%83%E9%99%90%E7%9A%84%E7%94%A8%E6%88%B7"><span class="nav-number">3.</span> <span class="nav-text">创建具有复制权限的用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEslave"><span class="nav-number">4.</span> <span class="nav-text">设置slave</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8Bmaster-slave%E9%85%8D%E7%BD%AE"><span class="nav-number">5.</span> <span class="nav-text">查看master&#x2F;slave配置</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">www.verynil.com</p>
  <div class="site-description" itemprop="description">记录生活，分享知识，传播乐趣</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">81</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">www.verynil.com</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
