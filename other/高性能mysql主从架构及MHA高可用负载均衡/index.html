
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="law">
      
      
        <link rel="canonical" href="https://www.verynil.com/other/%E9%AB%98%E6%80%A7%E8%83%BDmysql%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E5%8F%8AMHA%E9%AB%98%E5%8F%AF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.3">
    
    
      
        <title>高性能mysql主从架构及MHA高可用负载均衡 - 记录技术，分享知识，传播乐趣</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#4051b5">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="记录技术，分享知识，传播乐趣" class="md-header__button md-logo" aria-label="记录技术，分享知识，传播乐趣" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            记录技术，分享知识，传播乐趣
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              高性能mysql主从架构及MHA高可用负载均衡
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/captainQW/captainQW.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    verynil.github.io
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../algorithm/%E7%AE%97%E6%B3%95%E7%9A%84%E6%97%B6%E9%97%B4%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/" class="md-tabs__link">
        Algorithm
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../golang/fmt.Printf%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" class="md-tabs__link">
        Golang
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../drupal/Drupal-apc%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5/" class="md-tabs__link">
        Drupal
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../javascript/%3Bfunction%28%24%2Cundefined%29-%E5%89%8D%E9%9D%A2%E7%9A%84%E5%88%86%E5%8F%B7%E9%87%8A%E7%96%91/" class="md-tabs__link">
        Javascript
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../vue/Vue%E8%B7%AF%E7%94%B1%E5%85%A5%E9%97%A8/" class="md-tabs__link">
        Vue
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../CentOS6-4%E5%AE%89%E8%A3%85oracle-10g%E6%95%99%E7%A8%8B/" class="md-tabs__link md-tabs__link--active">
        Other
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        About
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="记录技术，分享知识，传播乐趣" class="md-nav__button md-logo" aria-label="记录技术，分享知识，传播乐趣" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    记录技术，分享知识，传播乐趣
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/captainQW/captainQW.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    verynil.github.io
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_1">
          Algorithm
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Algorithm" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Algorithm
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../algorithm/%E7%AE%97%E6%B3%95%E7%9A%84%E6%97%B6%E9%97%B4%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/" class="md-nav__link">
        算法的时间与空间复杂度
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Golang
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Golang" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Golang
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../golang/fmt.Printf%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" class="md-nav__link">
        Go 字符串格式化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../golang/%E6%96%B9%E6%B3%95%E4%B8%8E%E5%87%BD%E6%95%B0/" class="md-nav__link">
        Go 方法与函数
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Drupal
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Drupal" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Drupal
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/Drupal-apc%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5/" class="md-nav__link">
        Drupal apc缓存配置策略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/Drupal%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/" class="md-nav__link">
        Drupal动静分离
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/Drupal%E7%9A%84gitignore%E6%96%87%E4%BB%B6/" class="md-nav__link">
        Drupal的.gitignore文件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/Drush%E7%9A%84%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%92%8C%E5%BA%94%E7%94%A8/" class="md-nav__link">
        Drush的安装配置和应用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/SQLite-database-disk-image-is-malformed-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" class="md-nav__link">
        Drupal SQLite: database disk image is malformed 解决方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal%20code%20review/" class="md-nav__link">
        Drupal code review
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal-error-cannot-call-overloaded-function-for-non-object/" class="md-nav__link">
        Drupal error - Cannot call overloaded function for non-object
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal-%E8%8E%B7%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9C%9F%E5%AE%9Eip/" class="md-nav__link">
        Drupal 获取客户端真实IP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/hook_form%E4%B8%AD%E4%BD%BF%E7%94%A8drupalattachbehaviors/" class="md-nav__link">
        hook_form中使用Drupal.attachBehaviors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/windows%E4%B8%8B%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEdrupalconsole/" class="md-nav__link">
        windows下安装配置drupalconsole
      </a>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_11" type="checkbox" id="__nav_3_11" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_11">
          Drupal7
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Drupal7" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_11">
          <span class="md-nav__icon md-icon"></span>
          Drupal7
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal7/Converting-7-x-modules-to-8-x/" class="md-nav__link">
        Converting 7.x modules to 8.x
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal7/Drupal7-WEB%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="md-nav__link">
        Drupal7 WEB性能优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal7/Drupal7%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84%E4%B8%80%E4%BA%9B%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        Drupal7生产环境的一些配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal7/Drupal7%E8%A1%A8%E5%8D%95%E6%8F%90%E4%BA%A4%E6%97%B6%E5%87%BA%E7%8E%B0%E9%9D%9E%E6%B3%95%E9%80%89%E9%A1%B9%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="md-nav__link">
        Drupal7表单提交时出现非法选项解决方案
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_12" type="checkbox" id="__nav_3_12" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_12">
          Drupal8
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Drupal8" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_12">
          <span class="md-nav__icon md-icon"></span>
          Drupal8
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-Configuration-Schema/" class="md-nav__link">
        Drupal8 configuration schema
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-Content-Entity/" class="md-nav__link">
        Drupal8 Content Entity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-Controller/" class="md-nav__link">
        Drupal8 Controller
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-Cron-Queue/" class="md-nav__link">
        Drupal8 Cron Queue
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-Javascript/" class="md-nav__link">
        Drupal8 javascript
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-Service-DependencyInjection/" class="md-nav__link">
        Drupal8-Service-DependencyInjection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-angularJS/" class="md-nav__link">
        Drupal8中使用AngularJS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-configuration-Entity/" class="md-nav__link">
        Drupal8 Configuration Entity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-css-guide/" class="md-nav__link">
        Drupal8-css-guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-drush/" class="md-nav__link">
        Drush for Drupal8
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-form/" class="md-nav__link">
        Drupal8表单(form)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8-routing/" class="md-nav__link">
        Drupal8 Routing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E4%B8%BB%E9%A2%98-theme/" class="md-nav__link">
        Drupal8主题(theme)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95/" class="md-nav__link">
        Drupal8功能测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" class="md-nav__link">
        Drupal8单元测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4-Namespace/" class="md-nav__link">
        Drupal8命名空间(Namespace)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E5%AE%9E%E4%BD%93-entity/" class="md-nav__link">
        Drupal8实体(entity)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E6%95%B0%E6%8D%AE%E5%BA%93-database/" class="md-nav__link">
        Drupal8数据库(database)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E-twig/" class="md-nav__link">
        Drupal8模板引擎-twig
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E6%B3%A8%E8%A7%A3-Annotations-%E8%AF%AD%E6%B3%95/" class="md-nav__link">
        Drupal8注解(Annotations)语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E7%9B%B8%E5%AF%B9Drupal7%E7%9A%84%E5%8F%98%E5%8C%96/" class="md-nav__link">
        Drupal8相对Drupal7的变化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal8%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1-OOP/" class="md-nav__link">
        Drupal8面向对象(OOP)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/Drupal%E5%AF%BC%E5%85%A5%E7%BF%BB%E8%AF%91/" class="md-nav__link">
        Drupal导入翻译
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/drupal8%E4%B8%AD%E4%BD%BF%E7%94%A8vue/" class="md-nav__link">
        Drupal8中使用vue
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../drupal/drupal8/understanding-drupal8/" class="md-nav__link">
        understanding Drupal8-Drupal8初窥
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Javascript
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Javascript" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Javascript
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/%3Bfunction%28%24%2Cundefined%29-%E5%89%8D%E9%9D%A2%E7%9A%84%E5%88%86%E5%8F%B7%E9%87%8A%E7%96%91/" class="md-nav__link">
        ;function($,undefined) 前面的分号释疑
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/%E4%BD%BF%E7%94%A8safari%E5%AF%B9webview%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95/" class="md-nav__link">
        使用safari对webview进行调试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/%E5%86%99%E4%B8%AA%E8%84%9A%E6%9C%AC%E5%8E%8B%E7%BC%A9JS-CSS/" class="md-nav__link">
        写个脚本压缩JS,CSS
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5">
          Vue
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Vue" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Vue
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vue/Vue%E8%B7%AF%E7%94%B1%E5%85%A5%E9%97%A8/" class="md-nav__link">
        Vue路由入门
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vue/Vue%E8%B7%AF%E7%94%B1%E8%BF%9B%E9%98%B6/" class="md-nav__link">
        Vue路由进阶
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vue/vue%E5%9C%A8drupal%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%9D%97%E5%8C%96%E5%BC%80%E5%8F%91/" class="md-nav__link">
        vue在drupal中的模块化开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vue/%E4%BB%8E%E7%AE%80%E5%8D%95%E7%9A%84%E5%88%97%E8%A1%A8%E9%A1%B5%E6%B5%85%E8%B0%88Vue%E7%BB%84%E4%BB%B6/" class="md-nav__link">
        从简单的列表页浅谈Vue组件
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6">
          Other
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Other" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Other
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../CentOS6-4%E5%AE%89%E8%A3%85oracle-10g%E6%95%99%E7%A8%8B/" class="md-nav__link">
        CentOS6.4安装oracle 10g教程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Haproxy-web%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" class="md-nav__link">
        Haproxy web负载均衡
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../MacOS-%E6%9F%A5%E7%9C%8B%E7%BD%91%E7%BB%9C%E7%AB%AF%E5%8F%A3%E6%83%85%E5%86%B5/" class="md-nav__link">
        MacOS 查看网络端口情况
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Mariadb-ColumnStore%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B5%8B%E8%AF%95/" class="md-nav__link">
        Mariadb ColumnStore数据库测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../MySQL-5-7-x-%E5%AE%89%E8%A3%85/" class="md-nav__link">
        mysql-5.7.x安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../MySQL%E4%BA%92%E8%81%94%E7%BD%91%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/" class="md-nav__link">
        MySQL互联网业务数据库设计规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/" class="md-nav__link">
        MySQL数据库设计规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../PHP-Trait%E5%A4%9A%E9%87%8D%E7%BB%A7%E6%89%BF%E7%9A%84%E5%AE%9E%E7%8E%B0/" class="md-nav__link">
        PHP Trait多重继承的实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../centos6-6%E5%AE%89%E8%A3%85Percona-Tokudb/" class="md-nav__link">
        centos6.6安装Percona Tokudb
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../centos6-6%E5%AE%89%E8%A3%85mariadb10-Tokudb/" class="md-nav__link">
        centos6.6安装mariadb10 Tokudb
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../git%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/" class="md-nav__link">
        git自动化部属
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../infiniDB%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        infiniDB安装配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../infinidb%E4%B8%8Eclickhouse%E5%AF%B9%E6%AF%94/" class="md-nav__link">
        infiniDB与clickhouse对比
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../kubernetes%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98/" class="md-nav__link">
        kubernetes安装部署实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../macvim%E5%A4%84%E7%90%86%E4%B8%AD%E6%96%87%E6%97%B6%E5%8D%A1%E9%A1%BF%E3%80%81cpu%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E9%97%AE%E9%A2%98/" class="md-nav__link">
        MacVim处理中文时卡顿、CPU占用过高问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mariaDB%E5%92%8CPercona%E7%9A%84%E5%BC%95%E6%93%8Etokudb%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/" class="md-nav__link">
        MariaDB和Percona的引擎tokudb性能对比测试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../phantomjs%E4%B8%AD%E6%96%87%E9%97%AE%E9%A2%98/" class="md-nav__link">
        phantomjs中文问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../php-extension%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        PHP Extension开发基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../php%E8%8E%B7%E5%8F%96raw-post-data%E6%95%B0%E6%8D%AE/" class="md-nav__link">
        PHP获取Raw POST Data数据
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../rsync%E4%B8%BB%E5%A4%87%E4%BB%A3%E7%A0%81%E5%90%8C%E6%AD%A5/" class="md-nav__link">
        rsync主备代码同步
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sublime-text%E5%88%9B%E5%BB%BA%E5%BF%AB%E6%8D%B7%E6%B3%A8%E9%87%8A%E4%BF%A1%E6%81%AF/" class="md-nav__link">
        sublime text创建快捷注释信息
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sysbench%E6%B5%8B%E8%AF%95mysql%E6%80%A7%E8%83%BD/" class="md-nav__link">
        sysbench测试mysql性能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tpcc%E6%B5%8B%E8%AF%95mysql%E6%80%A7%E8%83%BD/" class="md-nav__link">
        tpcc测试mysql性能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../web%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83/" class="md-nav__link">
        web开发规范
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../yum-errno-14-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" class="md-nav__link">
        yum Errno 14 解决方法
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%B8%80%E4%BA%9B%E6%BA%90%EF%BC%9Aepel%2Crpmforge%2Cremi%E6%BA%90/" class="md-nav__link">
        一些源：epel,RPMForge,Remi源
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%B8%80%E8%A1%8C%E4%BB%A3%E7%A0%81%E8%A7%A3%E5%86%B3%E5%90%84%E7%A7%8Die%E5%85%BC%E5%AE%B9%E9%97%AE%E9%A2%98/" class="md-nav__link">
        一行代码解决各种IE兼容问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%BD%BF%E7%94%A8gdb%E8%B0%83%E8%AF%95php-fpm/" class="md-nav__link">
        使用gdb调试php-fpm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%AE%89%E8%A3%85php7/" class="md-nav__link">
        安装php7
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C/" class="md-nav__link">
        并发与并行
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%88%91%E7%9A%84vim%E9%85%8D%E8%89%B2/" class="md-nav__link">
        我的vim配色
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%9F%A5%E7%9C%8B%E5%93%AA%E4%BA%9B%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8%E4%BA%86swap/" class="md-nav__link">
        查看哪些进程占用了swap
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          高性能mysql主从架构及MHA高可用负载均衡
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        高性能mysql主从架构及MHA高可用负载均衡
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、安装软件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2mysql" class="md-nav__link">
    2、mysql主从配置
  </a>
  
    <nav class="md-nav" aria-label="2、mysql主从配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#masteretcmycnf" class="md-nav__link">
    master上编辑/etc/my.cnf，添加配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slaveetcmycnf" class="md-nav__link">
    slave上编辑/etc/my.cnf,添加配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    创建具有复制权限的用户
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slave" class="md-nav__link">
    设置slave
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#masterslave" class="md-nav__link">
    查看master/slave配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3mha" class="md-nav__link">
    3、MHA作用
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4mha" class="md-nav__link">
    4、配置MHA
  </a>
  
    <nav class="md-nav" aria-label="4、配置MHA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mha" class="md-nav__link">
    创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relay-logslave" class="md-nav__link">
    设置relay log的清除方式（在每个slave节点上）：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relayslave" class="md-nav__link">
    设置定期清理relay脚本（两台slave服务器）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#purge_relay_logssql" class="md-nav__link">
    purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5ssh" class="md-nav__link">
    5、SSH配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6、检查整个复制环境状况
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7mha-manager" class="md-nav__link">
    7、检查MHA Manager的状态
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8mha-manager" class="md-nav__link">
    8、开启MHA Manager监控
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9、查看启动日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10vip" class="md-nav__link">
    10、配置VIP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11send_report" class="md-nav__link">
    11、邮件发送脚本send_report
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    12、测试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    13、主库模拟故障后的恢复
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14" class="md-nav__link">
    14、报错记录总结
  </a>
  
    <nav class="md-nav" aria-label="14、报错记录总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    报错记录1：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    报错记录2：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    错误记录3：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    报错记录4：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    报错记录5：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6_1" class="md-nav__link">
    报错记录6：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    其他
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../about/">About</a>
          
        </div>
      
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1、安装软件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2mysql" class="md-nav__link">
    2、mysql主从配置
  </a>
  
    <nav class="md-nav" aria-label="2、mysql主从配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#masteretcmycnf" class="md-nav__link">
    master上编辑/etc/my.cnf，添加配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slaveetcmycnf" class="md-nav__link">
    slave上编辑/etc/my.cnf,添加配置
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    创建具有复制权限的用户
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#slave" class="md-nav__link">
    设置slave
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#masterslave" class="md-nav__link">
    查看master/slave配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3mha" class="md-nav__link">
    3、MHA作用
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4mha" class="md-nav__link">
    4、配置MHA
  </a>
  
    <nav class="md-nav" aria-label="4、配置MHA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mha" class="md-nav__link">
    创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relay-logslave" class="md-nav__link">
    设置relay log的清除方式（在每个slave节点上）：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#relayslave" class="md-nav__link">
    设置定期清理relay脚本（两台slave服务器）
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#purge_relay_logssql" class="md-nav__link">
    purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5ssh" class="md-nav__link">
    5、SSH配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    6、检查整个复制环境状况
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7mha-manager" class="md-nav__link">
    7、检查MHA Manager的状态
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8mha-manager" class="md-nav__link">
    8、开启MHA Manager监控
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    9、查看启动日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10vip" class="md-nav__link">
    10、配置VIP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11send_report" class="md-nav__link">
    11、邮件发送脚本send_report
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    12、测试
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    13、主库模拟故障后的恢复
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14" class="md-nav__link">
    14、报错记录总结
  </a>
  
    <nav class="md-nav" aria-label="14、报错记录总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    报错记录1：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    报错记录2：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    错误记录3：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    报错记录4：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    报错记录5：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6_1" class="md-nav__link">
    报错记录6：
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    其他
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/captainQW/captainQW.github.io/edit/master/docs/other/高性能mysql主从架构及MHA高可用负载均衡.md" title="编辑此页" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>高性能mysql主从架构及MHA高可用负载均衡</h1>

<p>实验系统：CentOS 6.7_x86_64（4.2.3）</p>
<p>实验前提：防火墙和selinux都关闭</p>
<p>实验说明：本实验共有3台主机，拓扑图如下所示</p>
<p><img alt="拓扑图" src="http://images.cnitblog.com/i/609710/201404/192216579327066.png" /></p>
<p>主机说明：
manager: 172.16.2.99
master: 172.16.115.101
备用master: 172.16.115.102
也可以加别的slave。</p>
<p>实验软件：</p>
<p>mha4mysql-manager-0.56-0.el6.noarch.rpm</p>
<p>mha4mysql-node-0.56-0.el6.noarch.rpm</p>
<p>mysql(mysql-5.5.46-1.el6.remi.x86_64)</p>
<h3 id="1">1、安装软件<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>三台机器都需要安装mha4mysql-node, master和slave还需要安装mysql, manager可以不装mysql. 当然manager也可以用slave机器来做。</p>
<div class="highlight"><pre><span></span><code>yum install mysql mysql-server epel-release -y

rpm -Uvh mha4mysql-node-0.56-0.el6.noarch.rpm
</code></pre></div>
<p>manager还需要安装mha4mysql-manager.</p>
<p><div class="highlight"><pre><span></span><code>yum localinstall mha4mysql-manager-0.56-0.el6.noarch.rpm -y
</code></pre></div>
用localinstall会自动安装依赖。</p>
<h3 id="2mysql">2、mysql主从配置<a class="headerlink" href="#2mysql" title="Permanent link">&para;</a></h3>
<h4 id="masteretcmycnf">master上编辑/etc/my.cnf，添加配置<a class="headerlink" href="#masteretcmycnf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># master config</span>
server-id <span class="o">=</span> <span class="m">1</span>
<span class="nv">log_bin</span> <span class="o">=</span> mysql-bin
log-slave-updates
<span class="nv">binlog_do_db</span> <span class="o">=</span> drupal
</code></pre></div>
<h4 id="slaveetcmycnf">slave上编辑/etc/my.cnf,添加配置<a class="headerlink" href="#slaveetcmycnf" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># slave config</span>
server-id <span class="o">=</span> <span class="m">2</span>
<span class="nv">log_bin</span> <span class="o">=</span> mysql-bin
log-slave-updates
<span class="nv">binlog_do_db</span> <span class="o">=</span> drupal
</code></pre></div>
<h4 id="_1">创建具有复制权限的用户<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>GRANT ALL PRIVILEGES ON *.* TO <span class="s1">&#39;replicate&#39;</span>@<span class="s1">&#39;%&#39;</span> IDENTIFIED BY <span class="s1">&#39;123456&#39;</span><span class="p">;</span>

FLUSH PRIVILEGES<span class="p">;</span>
</code></pre></div>
<h4 id="slave">设置slave<a class="headerlink" href="#slave" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>mysql -uroot -p123456

mysql&gt; change master to <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;172.16.115.101&#39;</span>,master_port<span class="o">=</span><span class="m">3306</span>,master_user<span class="o">=</span><span class="s1">&#39;repl&#39;</span>,master_password<span class="o">=</span><span class="s1">&#39;123456&#39;</span>,master_log_file<span class="o">=</span><span class="s1">&#39;mysql-bin.000001&#39;</span>,MASTER_LOG_POS<span class="o">=</span><span class="m">0</span><span class="p">;</span>

mysql&gt; start slave<span class="p">;</span>
</code></pre></div>
<h4 id="masterslave">查看master/slave配置<a class="headerlink" href="#masterslave" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>mysql&gt; show master status<span class="p">;</span>

+------------------+----------+--------------+------------------+
<span class="p">|</span> File             <span class="p">|</span> Position <span class="p">|</span> Binlog_Do_DB <span class="p">|</span> Binlog_Ignore_DB <span class="p">|</span>
+------------------+----------+--------------+------------------+
<span class="p">|</span> mysql-bin.000001 <span class="p">|</span>      <span class="m">867</span> <span class="p">|</span> drupal       <span class="p">|</span>                  <span class="p">|</span>
+------------------+----------+--------------+------------------+
<span class="m">1</span> row <span class="k">in</span> <span class="nb">set</span> <span class="o">(</span><span class="m">0</span>.00 sec<span class="o">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>mysql&gt; show slave status<span class="se">\G</span><span class="p">;</span>

*************************** <span class="m">1</span>. row ***************************
               Slave_IO_State: Waiting <span class="k">for</span> master to send event
                  Master_Host: <span class="m">172</span>.16.115.101
                  Master_User: repl
                  Master_Port: <span class="m">3306</span>
                Connect_Retry: <span class="m">60</span>
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: <span class="m">867</span>
               Relay_Log_File: mysqld-relay-bin.000002
                Relay_Log_Pos: <span class="m">1013</span>
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: drupal
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: <span class="m">0</span>
                   Last_Error: 
                 Skip_Counter: <span class="m">0</span>
          Exec_Master_Log_Pos: <span class="m">867</span>
              Relay_Log_Space: <span class="m">1170</span>
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: <span class="m">0</span>
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: <span class="m">0</span>
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: <span class="m">0</span>
                Last_IO_Error: 
               Last_SQL_Errno: <span class="m">0</span>
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: <span class="m">1</span>
<span class="m">1</span> row <span class="k">in</span> <span class="nb">set</span> <span class="o">(</span><span class="m">0</span>.00 sec<span class="o">)</span>
</code></pre></div>
<p>如果Slave_IO_Running和Slave_SQL_Running都是YES，说明slave服务器配置OK。</p>
<h3 id="3mha">3、MHA作用<a class="headerlink" href="#3mha" title="Permanent link">&para;</a></h3>
<p>1）从宕机崩溃的master保存二进制日志事件（binlog events）;</p>
<p>2）识别含有最新更新的slave；</p>
<p>3）应用差异的中继日志（relay log）到其他的slave；</p>
<p>4）应用从master保存的二进制日志事件（binlog events）；</p>
<p>5）提升一个slave为新的master；</p>
<p>6）使其他的slave连接新的master进行复制；</p>
<p>MHA软件由两部分组成，Manager工具包和Node工具包，具体的说明如下。</p>
<p>Manager工具包主要包括以下几个工具：</p>
<div class="highlight"><pre><span></span><code>masterha_check_ssh              检查MHA的SSH配置状况
masterha_check_repl             检查MySQL复制状况
masterha_manger                 启动MHA
masterha_check_status           检测当前MHA运行状态
masterha_master_monitor         检测master是否宕机
masterha_master_switch          控制故障转移（自动或者手动）
masterha_conf_host              添加或删除配置的server信息
</code></pre></div>
<p>Node工具包（这些工具通常由MHA Manager的脚本触发，无需人为操作）主要包括以下几个工具：</p>
<div class="highlight"><pre><span></span><code>save_binary_logs                保存和复制master的二进制日志
apply_diff_relay_logs           识别差异的中继日志事件并将其差异的事件应用于其他的slave
filter_mysqlbinlog              去除不必要的ROLLBACK事件（MHA已不再使用这个工具）
purge_relay_logs                清除中继日志（不会阻塞SQL线程）
</code></pre></div>
<h3 id="4mha">4、配置MHA<a class="headerlink" href="#4mha" title="Permanent link">&para;</a></h3>
<h4 id="mha">创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）<a class="headerlink" href="#mha" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 ~<span class="o">]</span><span class="c1"># vim /etc/masterha/app1.cnf </span>

<span class="o">[</span>server default<span class="o">]</span>
<span class="nv">manager_log</span><span class="o">=</span>/var/log/mha/app1/manager.log //设置manager的日志
<span class="nv">manager_workdir</span><span class="o">=</span>/var/log/mha/app1.log //设置manager的工作目录
<span class="nv">master_binlog_dir</span><span class="o">=</span>/var/lib/mysql //设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录

<span class="nv">user</span><span class="o">=</span>repl  //设置监控用户root
<span class="nv">password</span><span class="o">=</span><span class="m">123456</span> //设置mysql中root用户的密码，这个密码是前文中创建监控用户的那个密码
<span class="nv">ssh_user</span><span class="o">=</span>root //设置ssh的登录用户名
<span class="nv">repl_user</span><span class="o">=</span>repl //设置复制环境中的复制用户名
<span class="nv">repl_password</span><span class="o">=</span><span class="m">123456</span> //设置复制用户的密码
<span class="nv">ping_interval</span><span class="o">=</span><span class="m">10</span> //设置监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行railover

<span class="nv">shutdown_script</span><span class="o">=</span><span class="s2">&quot;&quot;</span> //设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）
<span class="nv">master_ip_online_change_script</span><span class="o">=</span><span class="s2">&quot;&quot;</span> //设置手动切换时候的切换脚本
<span class="nv">report_script</span><span class="o">=</span><span class="s2">&quot;/usr/bin/masterha_report_script&quot;</span> //设置发生切换后发送的报警的脚本
<span class="nv">master_ip_failover_script</span><span class="o">=</span><span class="s2">&quot;/usr/bin/masterha_ip_failover&quot;</span> //设置自动failover时候的切换脚本

<span class="o">[</span>server1<span class="o">]</span>
<span class="nv">hostname</span><span class="o">=</span><span class="m">172</span>.16.115.101

<span class="o">[</span>server2<span class="o">]</span>
<span class="nv">hostname</span><span class="o">=</span><span class="m">172</span>.16.115.102
<span class="nv">candidate_master</span><span class="o">=</span><span class="m">1</span> //设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中时间最新的slave
<span class="nv">check_repl_delay</span><span class="o">=</span><span class="m">0</span>   //默认情况下如果一个slave落后master 100M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay<span class="o">=</span><span class="m">0</span>,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master<span class="o">=</span>1的主机非常有用，因为这个候选主在切换的过程中一定是新的master
</code></pre></div>
<h4 id="relay-logslave">设置relay log的清除方式（在每个slave节点上）：<a class="headerlink" href="#relay-logslave" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@192.168.115.102 ~<span class="o">]</span><span class="c1"># mysql -e &#39;set global relay_log_purge=0&#39;</span>
</code></pre></div>
<p>注意：</p>
<p>MHA在发生切换的过程中，从库的恢复过程中依赖于relay log的相关信息，所以这里要将relay log的自动清除设置为OFF，采用手动清除relay log的方式。在默认情况下，从服务器上的中继日志会在SQL线程执行完毕后被自动删除。但是在MHA环境中，这些中继日志在恢复其他从服务器时可能会被用到，因此需要禁用中继日志的自动删除功能。定期清除中继日志需要考虑到复制延时的问题。在ext3的文件系统下，删除大的文件需要一定的时间，会导致严重的复制延时。为了避免复制延时，需要暂时为中继日志创建硬链接，因为在linux系统中通过硬链接删除大文件速度会很快。（在mysql数据库中，删除大表时，通常也采用建立硬链接的方式）</p>
<p>MHA节点中包含了pure_relay_logs命令工具，它可以为中继日志创建硬链接，执行SET GLOBAL relay_log_purge=1,等待几秒钟以便SQL线程切换到新的中继日志，再执行SET GLOBAL relay_log_purge=0。</p>
<p>pure_relay_logs脚本参数如下所示：</p>
<div class="highlight"><pre><span></span><code>--user mysql                      用户名
--password mysql                  密码
--port                            端口号
--workdir                         指定创建relay log的硬链接的位置，默认是/var/tmp，由于系统不同分区创建硬链接文件会失败，故需要执行硬链接具体位置，成功执行脚本后，硬链接的中继日志文件被删除
--disable_relay_log_purge         默认情况下，如果relay_log_purge<span class="o">=</span><span class="m">1</span>，脚本会什么都不清理，自动退出，通过设定这个参数，当relay_log_purge<span class="o">=</span>1的情况下会将relay_log_purge设置为0。清理relay log之后，最后将参数设置为OFF。
</code></pre></div>
<h4 id="relayslave">设置定期清理relay脚本（两台slave服务器）<a class="headerlink" href="#relayslave" title="Permanent link">&para;</a></h4>
<p><div class="highlight"><pre><span></span><code><span class="o">[</span>root@192.168.115.102 ~<span class="o">]</span><span class="c1"># cat purge_relay_log.sh </span>
<span class="c1">#!/bin/bash</span>
<span class="nv">user</span><span class="o">=</span>root
<span class="nv">passwd</span><span class="o">=</span><span class="m">123456</span>
<span class="nv">port</span><span class="o">=</span><span class="m">3306</span>
<span class="nv">log_dir</span><span class="o">=</span><span class="s1">&#39;/var/log/masterha&#39;</span>
<span class="nv">work_dir</span><span class="o">=</span><span class="s1">&#39;/var/lib/mysql&#39;</span>
<span class="nv">purge</span><span class="o">=</span><span class="s1">&#39;/usr/local/bin/purge_relay_logs&#39;</span>

<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$log_dir</span> <span class="o">]</span>
<span class="k">then</span>
   mkdir <span class="nv">$log_dir</span> -p
<span class="k">fi</span>

<span class="nv">$purge</span> --user<span class="o">=</span><span class="nv">$user</span> --password<span class="o">=</span><span class="nv">$passwd</span> --disable_relay_log_purge --port<span class="o">=</span><span class="nv">$port</span> --workdir<span class="o">=</span><span class="nv">$work_dir</span> &gt;&gt; <span class="nv">$log_dir</span>/purge_relay_logs.log <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</code></pre></div>
添加到crontab定期执行
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@192.168.115.102 ~<span class="o">]</span><span class="c1"># crontab -l</span>
<span class="m">0</span> <span class="m">4</span> * * * /bin/bash /root/purge_relay_log.sh
</code></pre></div></p>
<h4 id="purge_relay_logssql">purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。<a class="headerlink" href="#purge_relay_logssql" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@192.168.115.102 ~<span class="o">]</span><span class="c1"># purge_relay_logs --user=root --password=123456 --port=3306 -disable_relay_log_purge --workdir=/data/</span>
<span class="m">2014</span>-04-20 <span class="m">15</span>:47:24: purge_relay_logs script started.
 Found relay_log.info: /data/mysql/relay-log.info
 Removing hard linked relay log files server03-relay-bin* under /data/.. <span class="k">done</span>.
 Current relay log file: /data/mysql/server03-relay-bin.000002
 Archiving unused relay log files <span class="o">(</span>up to /data/mysql/server03-relay-bin.000001<span class="o">)</span> ...
 Creating hard link <span class="k">for</span> /data/mysql/server03-relay-bin.000001 under /data//server03-relay-bin.000001 .. ok.
 Creating hard links <span class="k">for</span> unused relay log files completed.
 Executing SET GLOBAL <span class="nv">relay_log_purge</span><span class="o">=</span><span class="m">1</span><span class="p">;</span> FLUSH LOGS<span class="p">;</span> sleeping a few seconds so that SQL thread can delete older relay log files <span class="o">(</span><span class="k">if</span> it keeps up<span class="o">)</span><span class="p">;</span> SET GLOBAL <span class="nv">relay_log_purge</span><span class="o">=</span><span class="m">0</span><span class="p">;</span> .. ok.
 Removing hard linked relay log files server03-relay-bin* under /data/.. <span class="k">done</span>.
<span class="m">2014</span>-04-20 <span class="m">15</span>:47:27: All relay log purging operations succeeded.
</code></pre></div>
<h3 id="5ssh">5、SSH配置<a class="headerlink" href="#5ssh" title="Permanent link">&para;</a></h3>
<p>要想MHA顺利执行各项任务，还得打通每台机器的SSH。</p>
<p><div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 app1<span class="o">]</span><span class="c1"># ssh-keygen -t rsa</span>
<span class="o">[</span>root@172.16.2.99 app1<span class="o">]</span><span class="c1"># ssh-copy-id -i .ssh/id_rsa.pub root@172.16.115.101</span>
.....
</code></pre></div>
记住，每台机器都要跟别的机器打通SSH。</p>
<p>检查MHA Manger到所有MHA Node的SSH连接状态：</p>
<p><div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 app1<span class="o">]</span><span class="c1"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> Global configuration file /etc/masterha_default.cnf not found. Skipping.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading application default configuration from /etc/masterha/app1.cnf..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading server configuration from /etc/masterha/app1.cnf..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Starting SSH connection tests..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span> 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span>  Connecting via SSH from root@172.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:22<span class="o">)</span> to root@172.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:22<span class="o">)</span>..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span>   ok.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:40 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span> 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span>  Connecting via SSH from root@172.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:22<span class="o">)</span> to root@172.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:22<span class="o">)</span>..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span>   ok.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> All SSH connection tests passed successfully.
</code></pre></div>
可以看见各个节点ssh验证都是ok的。</p>
<h3 id="6">6、检查整个复制环境状况<a class="headerlink" href="#6" title="Permanent link">&para;</a></h3>
<p>通过masterha_check_repl脚本查看整个集群的状态</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 app1<span class="o">]</span><span class="c1"># masterha_check_ssh --conf=/etc/masterha/app1.cnf  </span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> Global configuration file /etc/masterha_default.cnf not found. Skipping.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading application default configuration from /etc/masterha/app1.cnf..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading server configuration from /etc/masterha/app1.cnf..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Starting SSH connection tests..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span> 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span>  Connecting via SSH from root@172.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:22<span class="o">)</span> to root@172.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:22<span class="o">)</span>..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span>   ok.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:40 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span> 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span>  Connecting via SSH from root@172.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:22<span class="o">)</span> to root@172.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:22<span class="o">)</span>..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:39 <span class="m">2015</span> - <span class="o">[</span>debug<span class="o">]</span>   ok.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:42:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> All SSH connection tests passed successfully.
<span class="o">[</span>root@utn-cz-1-1-s16h2 app1.log<span class="o">]</span><span class="c1"># masterha_check_repl --conf=/etc/masterha/app1.cnf  </span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:49 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> Global configuration file /etc/masterha_default.cnf not found. Skipping.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:49 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading application default configuration from /etc/masterha/app1.cnf..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:49 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading server configuration from /etc/masterha/app1.cnf..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:49 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> MHA::MasterMonitor version <span class="m">0</span>.56.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> GTID failover <span class="nv">mode</span> <span class="o">=</span> <span class="m">0</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Dead Servers:
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Alive Servers:
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   <span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   <span class="m">172</span>.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Alive Slaves:
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   <span class="m">172</span>.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>  <span class="nv">Version</span><span class="o">=</span><span class="m">5</span>.5.46-log <span class="o">(</span>oldest major version between slaves<span class="o">)</span> log-bin:enabled
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>     Replicating from <span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>     Primary candidate <span class="k">for</span> the new Master <span class="o">(</span>candidate_master is <span class="nb">set</span><span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Current Alive Master: <span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking slave configurations..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  <span class="nv">read_only</span><span class="o">=</span><span class="m">1</span> is not <span class="nb">set</span> on slave <span class="m">172</span>.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span>  <span class="nv">relay_log_purge</span><span class="o">=</span><span class="m">0</span> is not <span class="nb">set</span> on slave <span class="m">172</span>.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking replication filtering settings..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  <span class="nv">binlog_do_db</span><span class="o">=</span> drupal, <span class="nv">binlog_ignore_db</span><span class="o">=</span> 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  Replication filtering check ok.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> GTID <span class="o">(</span>with auto-pos<span class="o">)</span> is not supported
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:50 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Starting SSH connection tests..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:51 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> All SSH connection tests passed successfully.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:51 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking MHA Node version..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:51 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  Version check ok.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:51 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking SSH publickey authentication settings on the current master..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:51 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> HealthCheck: SSH to <span class="m">172</span>.16.115.101 is reachable.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:51 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Master MHA Node version is <span class="m">0</span>.56.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:51 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking recovery script configurations on <span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span>..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:51 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Executing command: save_binary_logs --command<span class="o">=</span><span class="nb">test</span> --start_pos<span class="o">=</span><span class="m">4</span> --binlog_dir<span class="o">=</span>/var/lib/mysql --output_file<span class="o">=</span>/var/tmp/save_binary_logs_test --manager_version<span class="o">=</span><span class="m">0</span>.56 --start_file<span class="o">=</span>mysql-bin.000021 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:51 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Connecting to root@172.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:22<span class="o">)</span>.. 
  Creating /var/tmp <span class="k">if</span> not exists..    ok.
  Checking output directory is accessible or not..
   ok.
  Binlog found at /var/lib/mysql, up to mysql-bin.000021
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Binlog setting check <span class="k">done</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Executing <span class="nb">command</span> : apply_diff_relay_logs --command<span class="o">=</span><span class="nb">test</span> --slave_user<span class="o">=</span><span class="s1">&#39;repl&#39;</span> --slave_host<span class="o">=</span><span class="m">172</span>.16.115.102 --slave_ip<span class="o">=</span><span class="m">172</span>.16.115.102 --slave_port<span class="o">=</span><span class="m">3306</span> --workdir<span class="o">=</span>/var/tmp --target_version<span class="o">=</span><span class="m">5</span>.5.46-log --manager_version<span class="o">=</span><span class="m">0</span>.56 --relay_log_info<span class="o">=</span>/var/lib/mysql/relay-log.info  --relay_dir<span class="o">=</span>/var/lib/mysql/  --slave_pass<span class="o">=</span>xxx
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Connecting to root@172.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:22<span class="o">)</span>.. 
  Checking slave recovery environment settings..
    Opening /var/lib/mysql/relay-log.info ... ok.
    Relay log found at /var/lib/mysql, up to mysqld-relay-bin.000022
    Temporary relay log file is /var/lib/mysql/mysqld-relay-bin.000022
    Testing mysql connection and privileges.. <span class="k">done</span>.
    Testing mysqlbinlog output.. <span class="k">done</span>.
    Cleaning up <span class="nb">test</span> file<span class="o">(</span>s<span class="o">)</span>.. <span class="k">done</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Slaves settings check <span class="k">done</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> 
<span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span> <span class="o">(</span>current master<span class="o">)</span>
 +--172.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>

Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking replication health on <span class="m">172</span>.16.115.102..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  ok.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking master_ip_failover_script status:
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   /usr/bin/masterha_ip_failover --command<span class="o">=</span>status --ssh_user<span class="o">=</span>root --orig_master_host<span class="o">=</span><span class="m">172</span>.16.115.101 --orig_master_ip<span class="o">=</span><span class="m">172</span>.16.115.101 --orig_master_port<span class="o">=</span><span class="m">3306</span> 


IN SCRIPT <span class="nv">TEST</span><span class="o">====</span>/sbin/ifconfig eth0:0 <span class="nv">down</span><span class="o">==</span>/sbin/ifconfig eth0:0 <span class="m">172</span>.16.115.200/24<span class="o">===</span>

Checking the Status of the script.. OK 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  OK.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> shutdown_script is not defined.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:43:52 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Got <span class="nb">exit</span> code <span class="m">0</span> <span class="o">(</span>Not master dead<span class="o">)</span>.

MySQL Replication Health is OK.
</code></pre></div>
<h3 id="7mha-manager">7、检查MHA Manager的状态<a class="headerlink" href="#7mha-manager" title="Permanent link">&para;</a></h3>
<p>通过master_check_status脚本查看Manager的状态：</p>
<p><div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 ~<span class="o">]</span><span class="c1"># masterha_check_status --conf=/etc/masterha/app1.cnf</span>
app1 is stopped<span class="o">(</span><span class="m">2</span>:NOT_RUNNING<span class="o">)</span>.
</code></pre></div>
注意：如果正常，会显示"PING_OK"，否则会显示"NOT_RUNNING"，这代表MHA监控没有开启。</p>
<h3 id="8mha-manager">8、开启MHA Manager监控<a class="headerlink" href="#8mha-manager" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 ~<span class="o">]</span><span class="c1"># nohup masterha_manager --conf=/etc/masterha/app1.cnf --ignore_last_failover &gt; /var/log/mha/app1/manager.log &lt; /dev/null 2&gt;&amp;1 &amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="m">7303</span>
</code></pre></div>
<p>启动参数介绍：</p>
<div class="highlight"><pre><span></span><code>--remove_dead_master_conf      该参数代表当发生主从切换后，老的主库的ip将会从配置文件中移除。
--manger_log                            日志存放位置
--ignore_last_failover                 在缺省情况下，如果MHA检测到连续发生宕机，且两次宕机间隔不足8小时的话，则不会进行Failover，之所以这样限制是为了避免ping-pong效应。该参数代表忽略上次MHA触发切换产生的文件，默认情况下，MHA发生切换后会在日志目录，也就是上面我设置的/data产生app1.failover.complete文件，下次再次切换的时候如果发现该目录下存在该文件将不允许触发切换，除非在第一次切换后收到删除该文件，为了方便，这里设置为--ignore_last_failover。
</code></pre></div>
<p>查看MHA Manager监控是否正常：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 ~<span class="o">]</span><span class="c1"># masterha_check_status --conf=/etc/masterha/app1.cnf</span>
app1 <span class="o">(</span>pid:20386<span class="o">)</span> is running<span class="o">(</span><span class="m">0</span>:PING_OK<span class="o">)</span>, master:172.16.115.101
</code></pre></div>
<p>可以看见已经在监控了，而且master的主机为172.16.115.101</p>
<h3 id="9">9、查看启动日志<a class="headerlink" href="#9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 ~<span class="o">]</span><span class="c1">#  cat /var/log/mha/app1/manager.log</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:37 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> Global configuration file /etc/masterha_default.cnf not found. Skipping.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:37 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading application default configuration from /etc/masterha/app1.cnf..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:37 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading server configuration from /etc/masterha/app1.cnf..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:37 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> MHA::MasterMonitor version <span class="m">0</span>.56.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> GTID failover <span class="nv">mode</span> <span class="o">=</span> <span class="m">0</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Dead Servers:
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Alive Servers:
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   <span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   <span class="m">172</span>.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Alive Slaves:
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   <span class="m">172</span>.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>  <span class="nv">Version</span><span class="o">=</span><span class="m">5</span>.5.46-log <span class="o">(</span>oldest major version between slaves<span class="o">)</span> log-bin:enabled
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>     Replicating from <span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>     Primary candidate <span class="k">for</span> the new Master <span class="o">(</span>candidate_master is <span class="nb">set</span><span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Current Alive Master: <span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span>
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking slave configurations..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  <span class="nv">read_only</span><span class="o">=</span><span class="m">1</span> is not <span class="nb">set</span> on slave <span class="m">172</span>.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span>  <span class="nv">relay_log_purge</span><span class="o">=</span><span class="m">0</span> is not <span class="nb">set</span> on slave <span class="m">172</span>.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking replication filtering settings..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  <span class="nv">binlog_do_db</span><span class="o">=</span> drupal, <span class="nv">binlog_ignore_db</span><span class="o">=</span> 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  Replication filtering check ok.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> GTID <span class="o">(</span>with auto-pos<span class="o">)</span> is not supported
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:38 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Starting SSH connection tests..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> All SSH connection tests passed successfully.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking MHA Node version..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  Version check ok.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking SSH publickey authentication settings on the current master..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> HealthCheck: SSH to <span class="m">172</span>.16.115.101 is reachable.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Master MHA Node version is <span class="m">0</span>.56.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking recovery script configurations on <span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span>..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Executing command: save_binary_logs --command<span class="o">=</span><span class="nb">test</span> --start_pos<span class="o">=</span><span class="m">4</span> --binlog_dir<span class="o">=</span>/var/lib/mysql --output_file<span class="o">=</span>/var/tmp/save_binary_logs_test --manager_version<span class="o">=</span><span class="m">0</span>.56 --start_file<span class="o">=</span>mysql-bin.000021 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Connecting to root@172.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:22<span class="o">)</span>.. 
  Creating /var/tmp <span class="k">if</span> not exists..    ok.
  Checking output directory is accessible or not..
   ok.
  Binlog found at /var/lib/mysql, up to mysql-bin.000021
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Binlog setting check <span class="k">done</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking SSH publickey authentication and checking recovery script configurations on all alive slave servers..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Executing <span class="nb">command</span> : apply_diff_relay_logs --command<span class="o">=</span><span class="nb">test</span> --slave_user<span class="o">=</span><span class="s1">&#39;repl&#39;</span> --slave_host<span class="o">=</span><span class="m">172</span>.16.115.102 --slave_ip<span class="o">=</span><span class="m">172</span>.16.115.102 --slave_port<span class="o">=</span><span class="m">3306</span> --workdir<span class="o">=</span>/var/tmp --target_version<span class="o">=</span><span class="m">5</span>.5.46-log --manager_version<span class="o">=</span><span class="m">0</span>.56 --relay_log_info<span class="o">=</span>/var/lib/mysql/relay-log.info  --relay_dir<span class="o">=</span>/var/lib/mysql/  --slave_pass<span class="o">=</span>xxx
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:39 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Connecting to root@172.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:22<span class="o">)</span>.. 
  Checking slave recovery environment settings..
    Opening /var/lib/mysql/relay-log.info ... ok.
    Relay log found at /var/lib/mysql, up to mysqld-relay-bin.000022
    Temporary relay log file is /var/lib/mysql/mysqld-relay-bin.000022
    Testing mysql connection and privileges.. <span class="k">done</span>.
    Testing mysqlbinlog output.. <span class="k">done</span>.
    Cleaning up <span class="nb">test</span> file<span class="o">(</span>s<span class="o">)</span>.. <span class="k">done</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Slaves settings check <span class="k">done</span>.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> 
<span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span> <span class="o">(</span>current master<span class="o">)</span>
 +--172.16.115.102<span class="o">(</span><span class="m">172</span>.16.115.102:3306<span class="o">)</span>

Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking master_ip_failover_script status:
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   /usr/bin/masterha_ip_failover --command<span class="o">=</span>status --ssh_user<span class="o">=</span>root --orig_master_host<span class="o">=</span><span class="m">172</span>.16.115.101 --orig_master_ip<span class="o">=</span><span class="m">172</span>.16.115.101 --orig_master_port<span class="o">=</span><span class="m">3306</span> 


IN SCRIPT <span class="nv">TEST</span><span class="o">====</span>/sbin/ifconfig eth0:0 <span class="nv">down</span><span class="o">==</span>/sbin/ifconfig eth0:0 <span class="m">172</span>.16.115.200/24<span class="o">===</span>

Checking the Status of the script.. OK 
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  OK.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> shutdown_script is not defined.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Set master ping interval <span class="m">1</span> seconds.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> secondary_check_script is not defined. It is highly recommended setting it to check master reachability from two or more routes.
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Starting ping health check on <span class="m">172</span>.16.115.101<span class="o">(</span><span class="m">172</span>.16.115.101:3306<span class="o">)</span>..
Wed Dec  <span class="m">2</span> <span class="m">14</span>:46:40 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Ping<span class="o">(</span>SELECT<span class="o">)</span> succeeded, waiting <span class="k">until</span> MySQL doesn<span class="err">&#39;</span>t respond..
</code></pre></div>
<h3 id="10vip">10、配置VIP<a class="headerlink" href="#10vip" title="Permanent link">&para;</a></h3>
<p>我们采用脚本的方式去配置vip</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 ~<span class="o">]</span><span class="c1">#  vim /usr/bin/masterha_ip_failover</span>

<span class="c1">#!/usr/bin/env perl</span>

use strict<span class="p">;</span>
use warnings <span class="nv">FATAL</span> <span class="o">=</span>&gt; <span class="s1">&#39;all&#39;</span><span class="p">;</span>

use Getopt::Long<span class="p">;</span>

my <span class="o">(</span>
    <span class="nv">$command</span>,          <span class="nv">$ssh_user</span>,        <span class="nv">$orig_master_host</span>, <span class="nv">$orig_master_ip</span>,
    <span class="nv">$orig_master_port</span>, <span class="nv">$new_master_host</span>, <span class="nv">$new_master_ip</span>,    <span class="nv">$new_master_port</span>
<span class="o">)</span><span class="p">;</span>

my <span class="nv">$vip</span> <span class="o">=</span> <span class="s1">&#39;172.16.115.200/24&#39;</span><span class="p">;</span>
my <span class="nv">$key</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="p">;</span>
my <span class="nv">$ssh_start_vip</span> <span class="o">=</span> <span class="s2">&quot;/sbin/ifconfig eth0:</span><span class="nv">$key</span><span class="s2"> </span><span class="nv">$vip</span><span class="s2">&quot;</span><span class="p">;</span>
my <span class="nv">$ssh_stop_vip</span> <span class="o">=</span> <span class="s2">&quot;/sbin/ifconfig eth0:</span><span class="nv">$key</span><span class="s2"> down&quot;</span><span class="p">;</span>

GetOptions<span class="o">(</span>
    <span class="s1">&#39;command=s&#39;</span>          <span class="o">=</span>&gt; <span class="se">\$</span>command,
    <span class="s1">&#39;ssh_user=s&#39;</span>         <span class="o">=</span>&gt; <span class="se">\$</span>ssh_user,
    <span class="s1">&#39;orig_master_host=s&#39;</span> <span class="o">=</span>&gt; <span class="se">\$</span>orig_master_host,
    <span class="s1">&#39;orig_master_ip=s&#39;</span>   <span class="o">=</span>&gt; <span class="se">\$</span>orig_master_ip,
    <span class="s1">&#39;orig_master_port=i&#39;</span> <span class="o">=</span>&gt; <span class="se">\$</span>orig_master_port,
    <span class="s1">&#39;new_master_host=s&#39;</span>  <span class="o">=</span>&gt; <span class="se">\$</span>new_master_host,
    <span class="s1">&#39;new_master_ip=s&#39;</span>    <span class="o">=</span>&gt; <span class="se">\$</span>new_master_ip,
    <span class="s1">&#39;new_master_port=i&#39;</span>  <span class="o">=</span>&gt; <span class="se">\$</span>new_master_port,
<span class="o">)</span><span class="p">;</span>

<span class="nb">exit</span> <span class="p">&amp;</span>main<span class="o">()</span><span class="p">;</span>

sub main <span class="o">{</span>

    print <span class="s2">&quot;\n\nIN SCRIPT TEST====</span><span class="nv">$ssh_stop_vip</span><span class="s2">==</span><span class="nv">$ssh_start_vip</span><span class="s2">===\n\n&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="o">(</span> <span class="nv">$command</span> eq <span class="s2">&quot;stop&quot;</span> <span class="o">||</span> <span class="nv">$command</span> eq <span class="s2">&quot;stopssh&quot;</span> <span class="o">)</span> <span class="o">{</span>

        my <span class="nv">$exit_code</span> <span class="o">=</span> <span class="m">1</span><span class="p">;</span>
        <span class="nb">eval</span> <span class="o">{</span>
            print <span class="s2">&quot;Disabling the VIP on old master: </span><span class="nv">$orig_master_host</span><span class="s2"> \n&quot;</span><span class="p">;</span>
            <span class="p">&amp;</span>stop_vip<span class="o">()</span><span class="p">;</span>
            <span class="nv">$exit_code</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="o">}</span><span class="p">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="nv">$@</span><span class="o">)</span> <span class="o">{</span>
            warn <span class="s2">&quot;Got Error: </span><span class="nv">$@</span><span class="s2">\n&quot;</span><span class="p">;</span>
            <span class="nb">exit</span> <span class="nv">$exit_code</span><span class="p">;</span>
        <span class="o">}</span>
        <span class="nb">exit</span> <span class="nv">$exit_code</span><span class="p">;</span>
    <span class="o">}</span>
    elsif <span class="o">(</span> <span class="nv">$command</span> eq <span class="s2">&quot;start&quot;</span> <span class="o">)</span> <span class="o">{</span>

        my <span class="nv">$exit_code</span> <span class="o">=</span> <span class="m">10</span><span class="p">;</span>
        <span class="nb">eval</span> <span class="o">{</span>
            print <span class="s2">&quot;Enabling the VIP - </span><span class="nv">$vip</span><span class="s2"> on the new master - </span><span class="nv">$new_master_host</span><span class="s2"> \n&quot;</span><span class="p">;</span>
            <span class="p">&amp;</span>start_vip<span class="o">()</span><span class="p">;</span>
            <span class="nv">$exit_code</span> <span class="o">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="o">}</span><span class="p">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="nv">$@</span><span class="o">)</span> <span class="o">{</span>
            warn <span class="nv">$@</span><span class="p">;</span>
            <span class="nb">exit</span> <span class="nv">$exit_code</span><span class="p">;</span>
        <span class="o">}</span>
        <span class="nb">exit</span> <span class="nv">$exit_code</span><span class="p">;</span>
    <span class="o">}</span>
    elsif <span class="o">(</span> <span class="nv">$command</span> eq <span class="s2">&quot;status&quot;</span> <span class="o">)</span> <span class="o">{</span>
        print <span class="s2">&quot;Checking the Status of the script.. OK \n&quot;</span><span class="p">;</span>
        <span class="nb">exit</span> <span class="m">0</span><span class="p">;</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="p">&amp;</span>usage<span class="o">()</span><span class="p">;</span>
        <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>

sub start_vip<span class="o">()</span> <span class="o">{</span>
    <span class="sb">`</span>ssh <span class="nv">$ssh_user</span><span class="se">\@</span><span class="nv">$new_master_host</span> <span class="se">\&quot;</span> <span class="nv">$ssh_start_vip</span> <span class="se">\&quot;</span><span class="sb">`</span><span class="p">;</span>
<span class="o">}</span>
sub stop_vip<span class="o">()</span> <span class="o">{</span>
     <span class="k">return</span> <span class="m">0</span>  unless  <span class="o">(</span><span class="nv">$ssh_user</span><span class="o">)</span><span class="p">;</span>
    <span class="sb">`</span>ssh <span class="nv">$ssh_user</span><span class="se">\@</span><span class="nv">$orig_master_host</span> <span class="se">\&quot;</span> <span class="nv">$ssh_stop_vip</span> <span class="se">\&quot;</span><span class="sb">`</span><span class="p">;</span>
<span class="o">}</span>

sub usage <span class="o">{</span>
    print
    <span class="s2">&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip </span>
<span class="s2">            --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></div>
<h3 id="11send_report">11、邮件发送脚本send_report<a class="headerlink" href="#11send_report" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/perl</span>

<span class="c1">#  Copyright (C) 2011 DeNA Co.,Ltd.</span>
<span class="c1">#</span>
<span class="c1">#  This program is free software; you can redistribute it and/or modify</span>
<span class="c1">#  it under the terms of the GNU General Public License as published by</span>
<span class="c1">#  the Free Software Foundation; either version 2 of the License, or</span>
<span class="c1">#  (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#  This program is distributed in the hope that it will be useful,</span>
<span class="c1">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#  GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#  You should have received a copy of the GNU General Public License</span>
<span class="c1">#   along with this program; if not, write to the Free Software</span>
<span class="c1">#  Foundation, Inc.,</span>
<span class="c1">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span>

<span class="c1">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span>

use strict<span class="p">;</span>
use warnings <span class="nv">FATAL</span> <span class="o">=</span>&gt; <span class="s1">&#39;all&#39;</span><span class="p">;</span>
use Mail::Sender<span class="p">;</span>
use Getopt::Long<span class="p">;</span>

<span class="c1">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span>
my <span class="o">(</span> <span class="nv">$dead_master_host</span>, <span class="nv">$new_master_host</span>, <span class="nv">$new_slave_hosts</span>, <span class="nv">$subject</span>, <span class="nv">$body</span> <span class="o">)</span><span class="p">;</span>
my <span class="nv">$smtp</span><span class="o">=</span><span class="s1">&#39;smtp.163.com&#39;</span><span class="p">;</span>
my <span class="nv">$mail_from</span><span class="o">=</span><span class="s1">&#39;services@163.com&#39;</span><span class="p">;</span>
my <span class="nv">$mail_user</span><span class="o">=</span><span class="s1">&#39;services@163.com&#39;</span><span class="p">;</span>
my <span class="nv">$mail_pass</span><span class="o">=</span><span class="s1">&#39;123456&#39;</span><span class="p">;</span>
my <span class="nv">$mail_to</span><span class="o">=[</span><span class="s1">&#39;xxx@xxx.cn&#39;</span><span class="o">]</span><span class="p">;</span>
GetOptions<span class="o">(</span>
  <span class="s1">&#39;orig_master_host=s&#39;</span> <span class="o">=</span>&gt; <span class="se">\$</span>dead_master_host,
  <span class="s1">&#39;new_master_host=s&#39;</span>  <span class="o">=</span>&gt; <span class="se">\$</span>new_master_host,
  <span class="s1">&#39;new_slave_hosts=s&#39;</span>  <span class="o">=</span>&gt; <span class="se">\$</span>new_slave_hosts,
  <span class="s1">&#39;subject=s&#39;</span>          <span class="o">=</span>&gt; <span class="se">\$</span>subject,
  <span class="s1">&#39;body=s&#39;</span>             <span class="o">=</span>&gt; <span class="se">\$</span>body,
<span class="o">)</span><span class="p">;</span>

mailToContacts<span class="o">(</span><span class="nv">$smtp</span>,<span class="nv">$mail_from</span>,<span class="nv">$mail_user</span>,<span class="nv">$mail_pass</span>,<span class="nv">$mail_to</span>,<span class="nv">$subject</span>,<span class="nv">$body</span><span class="o">)</span><span class="p">;</span>

sub mailToContacts <span class="o">{</span>
    my <span class="o">(</span> <span class="nv">$smtp</span>, <span class="nv">$mail_from</span>, <span class="nv">$user</span>, <span class="nv">$passwd</span>, <span class="nv">$mail_to</span>, <span class="nv">$subject</span>, <span class="nv">$msg</span> <span class="o">)</span> <span class="o">=</span> @_<span class="p">;</span>
    open my <span class="nv">$DEBUG</span>, <span class="s2">&quot;&gt; /tmp/monitormail.log&quot;</span>
        or die <span class="s2">&quot;Can&#39;t open the debug      file:</span><span class="nv">$!</span><span class="s2">\n&quot;</span><span class="p">;</span>
    my <span class="nv">$sender</span> <span class="o">=</span> new Mail::Sender <span class="o">{</span>
        <span class="nv">ctype</span>       <span class="o">=</span>&gt; <span class="s1">&#39;text/plain; charset=utf-8&#39;</span>,
        <span class="nv">encoding</span>    <span class="o">=</span>&gt; <span class="s1">&#39;utf-8&#39;</span>,
        <span class="nv">smtp</span>        <span class="o">=</span>&gt; <span class="nv">$smtp</span>,
        <span class="nv">from</span>        <span class="o">=</span>&gt; <span class="nv">$mail_from</span>,
        <span class="nv">auth</span>        <span class="o">=</span>&gt; <span class="s1">&#39;LOGIN&#39;</span>,
        <span class="nv">TLS_allowed</span> <span class="o">=</span>&gt; <span class="s1">&#39;0&#39;</span>,
        <span class="nv">authid</span>      <span class="o">=</span>&gt; <span class="nv">$user</span>,
        <span class="nv">authpwd</span>     <span class="o">=</span>&gt; <span class="nv">$passwd</span>,
        <span class="nv">to</span>          <span class="o">=</span>&gt; <span class="nv">$mail_to</span>,
        <span class="nv">subject</span>     <span class="o">=</span>&gt; <span class="nv">$subject</span>,
        <span class="nv">debug</span>       <span class="o">=</span>&gt; <span class="nv">$DEBUG</span>
    <span class="o">}</span><span class="p">;</span>

    <span class="nv">$sender</span>-&gt;MailMsg<span class="o">(</span>
        <span class="o">{</span>   <span class="nv">msg</span>   <span class="o">=</span>&gt; <span class="nv">$msg</span>,
            <span class="nv">debug</span> <span class="o">=</span>&gt; <span class="nv">$DEBUG</span>
        <span class="o">}</span>
    <span class="o">)</span> or print <span class="nv">$Mail</span>::Sender::Error<span class="p">;</span>
    <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
<span class="o">}</span>



<span class="c1"># Do whatever you want here</span>

<span class="nb">exit</span> <span class="m">0</span><span class="p">;</span>
</code></pre></div>
<h3 id="12">12、测试<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<p>1.主库断电  <br />
2.主库断网<br />
3.主库重启<br />
4.主库关机<br />
以上情况都测试过都能自动切换~<br />
请看日志分析切换过程  </p>
<h3 id="13">13、主库模拟故障后的恢复<a class="headerlink" href="#13" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@172.16.2.99 app1<span class="o">]</span><span class="c1"># grep -i &quot;All other slaves should start&quot; manager.log </span>
Mon Apr <span class="m">21</span> <span class="m">22</span>:28:33 <span class="m">2014</span> - <span class="o">[</span>info<span class="o">]</span>  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO <span class="nv">MASTER_HOST</span><span class="o">=</span><span class="s1">&#39;172.16.115.102&#39;</span>, <span class="nv">MASTER_PORT</span><span class="o">=</span><span class="m">3306</span>, <span class="nv">MASTER_LOG_FILE</span><span class="o">=</span><span class="s1">&#39;mysql-bin.000022&#39;</span>, <span class="nv">MASTER_LOG_POS</span><span class="o">=</span><span class="m">506716</span>, <span class="nv">MASTER_USER</span><span class="o">=</span><span class="s1">&#39;repl&#39;</span>, <span class="nv">MASTER_PASSWORD</span><span class="o">=</span><span class="s1">&#39;xxx&#39;</span><span class="p">;</span>
<span class="o">[</span>root@192.168.0.20 app1<span class="o">]</span><span class="c1"># </span>
</code></pre></div>
<p>然后再就得主库里执行下,再start slave ,然后就得主库就变为了新的主库的从库了。<br />
记得看下show slave status\G;  </p>
<h3 id="14">14、报错记录总结<a class="headerlink" href="#14" title="Permanent link">&para;</a></h3>
<p>摘抄自google.</p>
<h4 id="1_1">报错记录1：<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@data01 ~<span class="o">]</span><span class="c1"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span>
Tue Apr <span class="m">7</span> <span class="m">22</span>:31:06 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> Global configuration file/etc/masterha_default.cnf not found. Skipping.
Tue Apr <span class="m">7</span> <span class="m">22</span>:31:07 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading application default configuration from/etc/masterha/app1.cnf..
Tue Apr <span class="m">7</span> <span class="m">22</span>:31:07 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading server configuration from/etc/masterha/app1.cnf..
Tue Apr <span class="m">7</span> <span class="m">22</span>:31:07 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> MHA::MasterMonitor version <span class="m">0</span>.56.
Tue Apr <span class="m">7</span> <span class="m">22</span>:31:07 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/Server.pm,ln303<span class="o">]</span>  Getting relay log directory orcurrent relay logfile from replication table failed on192.168.52.130<span class="o">(</span><span class="m">192</span>.168.52.130:3306<span class="o">)</span>!
Tue Apr <span class="m">7</span> <span class="m">22</span>:31:07 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln424<span class="o">]</span> Error happened on checking configurations.  at /usr/local/share/perl5/MHA/ServerManager.pmline <span class="m">315</span>
Tue Apr <span class="m">7</span> <span class="m">22</span>:31:07 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln523<span class="o">]</span> Error happened on monitoring servers.
Tue Apr <span class="m">7</span> <span class="m">22</span>:31:07 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Got <span class="nb">exit</span> code <span class="m">1</span> <span class="o">(</span>Not master dead<span class="o">)</span>.

MySQL Replication Health is NOT OK!
<span class="o">[</span>root@data01 ~<span class="o">]</span><span class="c1">#</span>
</code></pre></div>
<p>解决办法：在192.168.52.130上面，vim /etc/my.cnf，在里面添加</p>
<div class="highlight"><pre><span></span><code>relay-log<span class="o">=</span>/home/data/mysql/binlog/mysql-relay-bin
</code></pre></div>
<p>然后重启mysql，再去重新设置slave连接。</p>
<div class="highlight"><pre><span></span><code>STOP SLAVE<span class="p">;</span>
RESET SLAVE<span class="p">;</span>
CHANGE MASTER <span class="nv">TOMASTER_HOST</span><span class="o">=</span><span class="s1">&#39;192.168.52.129&#39;</span>,MASTER_USER<span class="o">=</span><span class="s1">&#39;repl&#39;</span>,MASTER_PASSWORD<span class="o">=</span><span class="s1">&#39;repl_1234&#39;</span>,MASTER_LOG_FILE<span class="o">=</span><span class="s1">&#39;mysql-bin.000178&#39;</span>,MASTER_LOG_POS<span class="o">=</span><span class="m">459</span><span class="p">;</span>
START SLAVE<span class="p">;</span>
</code></pre></div>
<p>Ok，搞定了。</p>
<h4 id="2">报错记录2：<a class="headerlink" href="#2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@data01 perl<span class="o">]</span><span class="c1"># masterha_check_repl--conf=/etc/masterha/app1.cnf</span>
Thu Apr <span class="m">9</span> <span class="m">00</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> Global configuration file/etc/masterha_default.cnf not found. Skipping.
Thu Apr <span class="m">9</span> <span class="m">00</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading application default configuration from/etc/masterha/app1.cnf..
Thu Apr <span class="m">9</span> <span class="m">00</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading server configuration from/etc/masterha/app1.cnf..
Thu Apr <span class="m">9</span> <span class="m">00</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> MHA::MasterMonitor version <span class="m">0</span>.56.
Thu Apr <span class="m">9</span> <span class="m">00</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/Server.pm,ln306<span class="o">]</span>  Getting relay log directory orcurrent relay logfile from replication table failed on <span class="m">192</span>.168.52.130<span class="o">(</span><span class="m">192</span>.168.52.130:3306<span class="o">)</span>!
Thu Apr <span class="m">9</span> <span class="m">00</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln424<span class="o">]</span> Error happened on checking configurations.  at/usr/local/share/perl5/MHA/ServerManager.pm line <span class="m">315</span>
Thu Apr <span class="m">9</span> <span class="m">00</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln523<span class="o">]</span> Error happened on monitoring servers.
Thu Apr <span class="m">9</span> <span class="m">00</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Got <span class="nb">exit</span> code <span class="m">1</span> <span class="o">(</span>Not master dead<span class="o">)</span>.

MySQL Replication Health is NOT OK!
<span class="o">[</span>root@data01 perl<span class="o">]</span><span class="c1">#</span>
</code></pre></div>
<p>解决方法：
/etc/masterha/app1.cnf文件里面的参数配置，user和repl_user都是mysql账号，需要创建好，这里是只创建了repl_user而没有创建好user账号：</p>
<div class="highlight"><pre><span></span><code><span class="nv">user</span><span class="o">=</span>manager
<span class="nv">password</span><span class="o">=</span>manager_1234
<span class="nv">repl_user</span><span class="o">=</span>repl
<span class="nv">repl_password</span><span class="o">=</span>repl_1234
</code></pre></div>
<p>在mysql节点上，建立允许manager 访问数据库的“ manager manager ”账户，主要用于SHOW SLAVESTATUS,RESET SLAVE; 所以需要执行如下命令：</p>
<div class="highlight"><pre><span></span><code>GRANT SUPER,RELOAD,REPLICATIONCLIENT,SELECT ON *.* TO manager@<span class="s1">&#39;192.168.52.%&#39;</span> IDENTIFIED BY <span class="s1">&#39;manager_1234&#39;</span><span class="p">;</span>
</code></pre></div>
<h4 id="3">错误记录3：<a class="headerlink" href="#3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@oraclem1 ~<span class="o">]</span><span class="c1">#  masterha_check_repl--conf=/etc/masterha/app1.cnf</span>
Thu Apr <span class="m">9</span> <span class="m">23</span>:09:05 <span class="m">2015</span> - <span class="o">[</span>warning<span class="o">]</span> Global configuration file/etc/masterha_default.cnf not found. Skipping.
Thu Apr <span class="m">9</span> <span class="m">23</span>:09:05 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading application default configuration from/etc/masterha/app1.cnf..
Thu Apr <span class="m">9</span> <span class="m">23</span>:09:05 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Reading server configuration from/etc/masterha/app1.cnf..
Thu Apr <span class="m">9</span> <span class="m">23</span>:09:05 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> MHA::MasterMonitor version <span class="m">0</span>.56.
Thu Apr <span class="m">9</span> <span class="m">23</span>:09:05 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/ServerManager.pm,ln781<span class="o">]</span> Multi-master configuration is detected, but two or more masters areeither writable <span class="o">(</span>read-only is not <span class="nb">set</span><span class="o">)</span> or dead! Check configurations fordetails. Master configurations are as below:
Master <span class="m">192</span>.168.52.130<span class="o">(</span><span class="m">192</span>.168.52.130:3306<span class="o">)</span>,replicating from <span class="m">192</span>.168.52.129<span class="o">(</span><span class="m">192</span>.168.52.129:3306<span class="o">)</span>
Master <span class="m">192</span>.168.52.129<span class="o">(</span><span class="m">192</span>.168.52.129:3306<span class="o">)</span>,replicating from <span class="m">192</span>.168.52.130<span class="o">(</span><span class="m">192</span>.168.52.130:3306<span class="o">)</span>

Thu Apr <span class="m">9</span> <span class="m">23</span>:09:05 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln424<span class="o">]</span> Error happened on checking configurations.  at/usr/local/share/perl5/MHA/MasterMonitor.pm line <span class="m">326</span>
Thu Apr <span class="m">9</span> <span class="m">23</span>:09:05 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln523<span class="o">]</span> Error happened on monitoring servers.
Thu Apr <span class="m">9</span> <span class="m">23</span>:09:05 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Got <span class="nb">exit</span> code <span class="m">1</span> <span class="o">(</span>Not master dead<span class="o">)</span>.

MySQL Replication Health is NOT OK!
<span class="o">[</span>root@oraclem1 ~<span class="o">]</span><span class="c1">#</span>
</code></pre></div>
<p>解决办法：</p>
<div class="highlight"><pre><span></span><code>mysql&gt; <span class="nb">set</span> global <span class="nv">read_only</span><span class="o">=</span><span class="m">1</span><span class="p">;</span>
Query OK, <span class="m">0</span> rows affected <span class="o">(</span><span class="m">0</span>.00 sec<span class="o">)</span>

mysql&gt;
</code></pre></div>
<h4 id="4">报错记录4：<a class="headerlink" href="#4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Thu Apr <span class="m">9</span> <span class="m">23</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Checking SSH publickey authentication andchecking recovery script configurations on all alive slave servers..
Thu Apr <span class="m">9</span> <span class="m">23</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  Executing <span class="nb">command</span> : apply_diff_relay_logs --command<span class="o">=</span>test--slave_user<span class="o">=</span><span class="s1">&#39;manager&#39;</span> --slave_host<span class="o">=</span><span class="m">192</span>.168.52.130 --slave_ip<span class="o">=</span><span class="m">192</span>.168.52.130--slave_port<span class="o">=</span><span class="m">3306</span> --workdir<span class="o">=</span>/var/tmp --target_version<span class="o">=</span><span class="m">5</span>.6.12-log--manager_version<span class="o">=</span><span class="m">0</span>.56 --relay_dir<span class="o">=</span>/home/data/mysql/data--current_relay_log<span class="o">=</span>mysqld-relay-bin.000011 --slave_pass<span class="o">=</span>xxx
Thu Apr <span class="m">9</span> <span class="m">23</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  Connecting to root@192.168.52.130<span class="o">(</span><span class="m">192</span>.168.52.130:22<span class="o">)</span>..
Can<span class="err">&#39;</span>t <span class="nb">exec</span> <span class="s2">&quot;mysqlbinlog&quot;</span>: No suchfile or directory at /usr/local/share/perl5/MHA/BinlogManager.pm line <span class="m">106</span>.
mysqlbinlog version <span class="nb">command</span> failed with rc1:0, please verify PATH, LD_LIBRARY_PATH, and client options
 at/usr/local/bin/apply_diff_relay_logs line <span class="m">493</span>
Thu Apr <span class="m">9</span> <span class="m">23</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln205<span class="o">]</span> Slaves settings check failed!
Thu Apr <span class="m">9</span> <span class="m">23</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln413<span class="o">]</span> Slave configuration failed.
Thu Apr <span class="m">9</span> <span class="m">23</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln424<span class="o">]</span> Error happened on checking configurations.  at /usr/local/bin/masterha_check_repl line <span class="m">48</span>
Thu Apr <span class="m">9</span> <span class="m">23</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln523<span class="o">]</span> Error happened on monitoring servers.
Thu Apr <span class="m">9</span> <span class="m">23</span>:54:32 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Got <span class="nb">exit</span> code <span class="m">1</span> <span class="o">(</span>Not master dead<span class="o">)</span>.

MySQL Replication Health is NOT OK!
<span class="o">[</span>root@oraclem1 ~<span class="o">]</span><span class="c1">#</span>
</code></pre></div>
<p>解决办法：</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>root@data02 ~<span class="o">]</span><span class="c1"># type mysqlbinlog</span>
mysqlbinlog is/usr/local/mysql/bin/mysqlbinlog
<span class="o">[</span>root@data02 ~<span class="o">]</span><span class="c1">#</span>
<span class="o">[</span>root@data02 ~<span class="o">]</span><span class="c1"># ln -s/usr/local/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog</span>
</code></pre></div>
<h4 id="5">报错记录5：<a class="headerlink" href="#5" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Thu Apr <span class="m">9</span> <span class="m">23</span>:57:24 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>  Connecting to root@192.168.52.130<span class="o">(</span><span class="m">192</span>.168.52.130:22<span class="o">)</span>..
 Checking slave recovery environment settings..
   Relay log found at /home/data/mysql/data, up to mysqld-relay-bin.000013
   Temporary relay log file is /home/data/mysql/data/mysqld-relay-bin.000013
   Testing mysql connection and privileges..sh: mysql: <span class="nb">command</span> not found
mysql <span class="nb">command</span> failed with rc <span class="m">127</span>:0!
 at/usr/local/bin/apply_diff_relay_logs line <span class="m">375</span>
         main::check<span class="o">()</span>called at /usr/local/bin/apply_diff_relay_logs line <span class="m">497</span>
         eval<span class="o">{</span>...<span class="o">}</span> called at /usr/local/bin/apply_diff_relay_logs line <span class="m">475</span>
         main::main<span class="o">()</span>called at /usr/local/bin/apply_diff_relay_logs line <span class="m">120</span>
Thu Apr <span class="m">9</span> <span class="m">23</span>:57:24 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln205<span class="o">]</span> Slaves settings check failed!
Thu Apr <span class="m">9</span> <span class="m">23</span>:57:24 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln413<span class="o">]</span> Slave configuration failed.
Thu Apr <span class="m">9</span> <span class="m">23</span>:57:24 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln424<span class="o">]</span> Error happened on checking configurations.  at /usr/local/bin/masterha_check_repl line <span class="m">48</span>
Thu Apr <span class="m">9</span> <span class="m">23</span>:57:24 <span class="m">2015</span> - <span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm,ln523<span class="o">]</span> Error happened on monitoring servers.
Thu Apr <span class="m">9</span> <span class="m">23</span>:57:24 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Got <span class="nb">exit</span> code <span class="m">1</span> <span class="o">(</span>Not master dead<span class="o">)</span>.

MySQL Replication Health is NOT OK!
</code></pre></div>
<p>解决办法：</p>
<div class="highlight"><pre><span></span><code>ln -s /usr/local/mysql/bin/mysql/usr/bin/mysql
</code></pre></div>
<h4 id="6_1">报错记录6：<a class="headerlink" href="#6_1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Fri Apr <span class="m">10</span> <span class="m">00</span>:58:36 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Executing <span class="nb">command</span> : apply_diff_relay_logs--command<span class="o">=</span><span class="nb">test</span> --slave_user<span class="o">=</span><span class="s1">&#39;manager&#39;</span> --slave_host<span class="o">=</span><span class="m">192</span>.168.52.130--slave_ip<span class="o">=</span><span class="m">192</span>.168.52.130 --slave_port<span class="o">=</span><span class="m">3306</span> --workdir<span class="o">=</span>/var/tmp--target_version<span class="o">=</span><span class="m">5</span>.6.12-log --manager_version<span class="o">=</span><span class="m">0</span>.56--relay_dir<span class="o">=</span>/home/data/mysql/data--current_relay_log<span class="o">=</span>mysqld-relay-bin.000011 --slave_pass<span class="o">=</span>xxx
Fri Apr <span class="m">10</span> <span class="m">00</span>:58:36 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span>   Connecting to root@192.168.52.130<span class="o">(</span><span class="m">192</span>.168.52.130:22<span class="o">)</span>..
 Checking slave recovery environment settings..
   Relay log found at /home/data/mysql/data, up to mysqld-relay-bin.000013
   Temporary relay log file is/home/data/mysql/data/mysqld-relay-bin.000013
   Testing mysql connection and privileges..Warning: Using a password onthe <span class="nb">command</span> line interface can be insecure.
ERROR <span class="m">1142</span> <span class="o">(</span><span class="m">42000</span><span class="o">)</span> at line <span class="m">1</span>: CREATEcommand denied to user <span class="s1">&#39;manager&#39;</span>@<span class="s1">&#39;192.168.52.130&#39;</span> <span class="k">for</span> table<span class="s1">&#39;apply_diff_relay_logs_test&#39;</span>
mysql <span class="nb">command</span> failed with rc <span class="m">1</span>:0!
 at/usr/local/bin/apply_diff_relay_logs line <span class="m">375</span>
         main::check<span class="o">()</span>called at /usr/local/bin/apply_diff_relay_logs line <span class="m">497</span>
         eval<span class="o">{</span>...<span class="o">}</span> called at /usr/local/bin/apply_diff_relay_logs line <span class="m">475</span>
         main::main<span class="o">()</span>called at /usr/local/bin/apply_diff_relay_logs line <span class="m">120</span>
Fri Apr <span class="m">10</span> <span class="m">00</span>:58:37 <span class="m">2015</span> -<span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm, ln205<span class="o">]</span> Slaves settingscheck failed!
Fri Apr <span class="m">10</span> <span class="m">00</span>:58:37 <span class="m">2015</span> -<span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm, ln413<span class="o">]</span> Slave configurationfailed.
Fri Apr <span class="m">10</span> <span class="m">00</span>:58:37 <span class="m">2015</span> -<span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm, ln424<span class="o">]</span> Error happened onchecking configurations.  at/usr/local/bin/masterha_check_repl line <span class="m">48</span>
Fri Apr <span class="m">10</span> <span class="m">00</span>:58:37 <span class="m">2015</span> -<span class="o">[</span>error<span class="o">][</span>/usr/local/share/perl5/MHA/MasterMonitor.pm, ln523<span class="o">]</span> Error happened onmonitoring servers.
Fri Apr <span class="m">10</span> <span class="m">00</span>:58:37 <span class="m">2015</span> - <span class="o">[</span>info<span class="o">]</span> Got exitcode <span class="m">1</span> <span class="o">(</span>Not master dead<span class="o">)</span>.

MySQL Replication Health is NOT OK!
</code></pre></div>
<p>解决办法：
执行如下授权语句sql：</p>
<div class="highlight"><pre><span></span><code>GRANT CREATE,INSERT,UPDATE,DELETE,DROP ON*.* TO manager@<span class="s1">&#39;192.168.52.%&#39;</span><span class="p">;</span>
</code></pre></div>
<h4 id="_2">其他<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>另外，如果nohup masterha_manager执行不了，请检查master和slave是否配置正确。可以通过</p>
<div class="highlight"><pre><span></span><code>change master to <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;172.16.115.101&#39;</span>,master_port<span class="o">=</span><span class="m">3306</span>,master_user<span class="o">=</span><span class="s1">&#39;repl&#39;</span>,master_password<span class="o">=</span><span class="s1">&#39;123456&#39;</span>,master_log_file<span class="o">=</span><span class="s1">&#39;mysql-bin.000001&#39;</span>,MASTER_LOG_POS<span class="o">=</span><span class="m">0</span><span class="p">;</span>
</code></pre></div>
<p>重新设置slave。</p>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="页脚" >
      
        
        <a href="../%E6%9F%A5%E7%9C%8B%E5%93%AA%E4%BA%9B%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8%E4%BA%86swap/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 查看哪些进程占用了swap" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              查看哪些进程占用了swap
            </div>
          </div>
        </a>
      
      
        
        <a href="../../about/" class="md-footer__link md-footer__link--next" aria-label="下一页: 关于我" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              关于我
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "content.code.annotate", "content.tooltips", "navigation.indexes", "navigation.sections", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>